<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>VINO v2.4 - Version Int√©grale Corrig√©e</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Lato:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* --- STYLES ORIGINAUX CONSERV√âS --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #1E3A5F; --primary-dark: #0F2744; --secondary: #D4AF37;
            --bg-light: #F8F6F3; --text-dark: #2C2C2C; --text-light: #6B6B6B;
            --border: #E8E3DC; --cellier1: #8B4513; --cellier2: #2F4F4F; --cellier3: #8B0000;
        }
        body { font-family: 'Lato', sans-serif; background: #000; color: var(--text-dark); padding-bottom: 80px; position: relative; min-height: 100vh; }
        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyMCIgaGVpZ2h0PSIxMDgwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxkZWZzPjxsaW5lYXJHcmFkaWVudCBpZD0ic2t5IiB4MT0iMCUiIHkxPSIwJSIgeDI9IjAlIiB5Mj0iMTAwJSI+PHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6IzJENEE2RTtzdG9wLW9wYWNpdHk6MSIvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3R5bGU9InN0b3AtY29sb3I6IzFBMjkzQztzdG9wLW9wYWNpdHk6MSIvPjbHVsIHNreSkgd2lkdGg9IjE5MjAiIGhlaWdodD0iMTA4MCIvPjxwYXRoIGZpbGw9IiMxQTI5M0MiIGQ9Ik0wLDUwMCBRNDgwLDQ1MCA5NjAsNTAwIFQxOTIwLDUwMCBMMTkyMCwxMDgwIEwwLDEwODAgWiIvPjxlbGxpcHNlIGN4PSI0MDAiIGN5PSI2MDAiIHJ4PSIxNTAiIHJ5PSI1MCIgZmlsbD0iIzFGM0UyRCIgb3BhY2l0eT0iMC42Ii8+PGVsbGlwc2UgY3g9IjEwMDAiIGN5PSI2NTAiIHJ4PSIyMDAiIHJ5PSI2MCIgZmlsbD0iIzFGM0UyRCIgb3BhY2l0eT0iMC41Ii8+PGVsbGlwc2UgY3g9IjE2MDAiIGN5PSI2MjAiIHJ4PSIxODAiIHJ5PSI1NSIgZmlsbD0iIzFGM0UyRCIgb3BhY2l0eT0iMC42Ii8+PC9zdmc+') center center / cover;
        }
        .header { background: rgba(30, 58, 95, 0.95); backdrop-filter: blur(10px); padding: 16px 20px; text-align: center; box-shadow: 0 2px 20px rgba(0,0,0,0.3); position: relative; }
        .version { position: absolute; top: 8px; right: 12px; font-size: 9px; color: rgba(255, 255, 255, 0.5); font-weight: 300; }
        .header h1 { font-family: 'Playfair Display', serif; font-size: 52px; font-weight: 700; color: var(--secondary); letter-spacing: 8px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .subtitle { font-size: 12px; color: rgba(255, 255, 255, 0.8); letter-spacing: 3px; text-transform: uppercase; font-weight: 300; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .page { display: none; }
        .page.active { display: block; }
        .nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(30, 58, 95, 0.98); backdrop-filter: blur(15px); display: flex; justify-content: space-around; padding: 8px 0 max(8px, env(safe-area-inset-bottom)); box-shadow: 0 -2px 20px rgba(0,0,0,0.3); z-index: 100; }
        .nav-item { flex: 1; text-align: center; color: rgba(255, 255, 255, 0.6); padding: 8px 4px; cursor: pointer; transition: all 0.3s; font-size: 20px; }
        .nav-item.active { color: var(--secondary); }
        .nav-label { font-size: 9px; margin-top: 2px; text-transform: uppercase; }
        .scan-hero { text-align: center; padding: 60px 20px 40px; }
        .btn-scan-large { width: 120px; height: 120px; border-radius: 50%; border: none; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; font-size: 52px; cursor: pointer; box-shadow: 0 8px 30px rgba(30, 58, 95, 0.4); }
        .wine-card { background: rgba(255, 255, 255, 0.95); padding: 16px; margin-bottom: 12px; border-left: 4px solid var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .wine-name { font-family: 'Playfair Display', serif; font-size: 18px; font-weight: 600; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); z-index: 200; overflow-y: auto; padding: 20px; }
        .modal.active { display: flex; align-items: flex-start; justify-content: center; }
        .modal-content { background: white; padding: 24px; max-width: 600px; width: 100%; margin: 20px auto; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid var(--border); }
        .checkbox-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; max-height: 200px; overflow-y: auto; border: 1px solid var(--border); padding: 12px; background: var(--bg-light); }
        .location-entry { background: #f9f9f9; padding: 15px; border: 1px solid #eee; margin-bottom: 10px; position: relative; }
        #scanner { display: none; position: fixed; inset: 0; background: black; z-index: 1000; }
        #scanner.active { display: block; }
        #scannerVideo { width: 100%; height: 100%; }
        #scannerVideo video { width: 100%; height: 100%; object-fit: cover; }
        .toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 12px 24px; border-radius: 4px; opacity: 0; transition: opacity 0.3s; z-index: 2000; }
        .toast.show { opacity: 1; }
   
.nav-item {
            font-size: 6vw; /* 6% de la largeur de l‚Äô√©cran */
            transition: transform 0.3s ease;
        }
 </style>
</head>






    
<body>

    <div class="header">
        <div class="version">11/01/2026 v2.4 PRECISION</div>
        <h1>VINO</h1>
        <div class="subtitle">C</div>
    </div>

    <div class="container">
        <div id="page1" class="page active">
            <div style="text-align: center; margin-top: 20px;">
                <span id="totalBottles" style="font-size: 60px; font-weight: 700; color: var(--secondary);">0</span>
                <p style="color: white; letter-spacing: 2px; text-transform: uppercase;">Bouteilles au total</p>
            </div>
            
            <div class="scan-hero">
                <div style="display: flex; justify-content: center; gap: 40px;">
                    <button class="btn-scan-large" onclick="app.quickScan()">üì∑</button>
                    <button class="btn-scan-large" onclick="app.showWineModal()">‚å®Ô∏è</button>
                </div>
            </div>
           
            <div id="grapeSummaryGrid" class="checkbox-grid" style="margin-top: 30px; border:none; background:none;"></div>
        </div>




        

        <div id="page2" class="page">
            <div style="background: white; padding: 20px; margin-bottom: 20px;">
                <input type="text" id="searchWine" placeholder="Rechercher un vin..." onkeyup="app.render()" style="width:100%; padding:15px; border:1px solid #ddd;">
                <select id="filterType" onchange="app.render()" style="width:100%; margin-top:10px; padding:10px;">
                    <option value="">Tous les types</option>
                    <option value="Rouge">Rouge</option><option value="Blanc">Blanc</option><option value="Ros√©">Ros√©</option><option value="Mousseux">Mousseux</option>
                </select>
            </div>
            <div id="wineList"></div>
        </div>






        

        <div id="page3" class="page">
            <select id="viewZone" onchange="app.showLocations()" style="width:100%; padding:15px; margin-bottom:20px;">
                <option value="1">Cellier</option><option value="2">√âtag√®re</option><option value="3">R√©serve</option>
            </select>
            <div id="locationView"></div>
        </div>








        
        <div id="page4" class="page">
            <div id="cepageView" style="color: white;"></div>
        </div>

   
        
        
        
        
        <div id="page5" class="page">
            <div id="shoppingList"></div>
        </div>

  
        
        
        
        <div id="page6" class="page">
            <div style="background: white; padding: 20px; display: flex; flex-direction: column; gap: 15px;">
               
                <button onclick="app.exportToExcel()" style="padding:15px; background:var(--primary); color:white; border:none;">EXPORTER EXCEL</button>
                <input type="file" id="importFile" accept=".json,.xlsx" style="display:none" onchange="app.handleImport(event)">
                <button onclick="document.getElementById('importFile').click()" style="padding:15px; background:var(--primary); color:white; border:none;">IMPORTER DONN√âES</button>
            </div>
        </div>
    </div>

    <div class="nav">
        <div class="nav-item active" onclick="app.showPage(1, this)">üì∑<div class="nav-label"></div></div>
        <div class="nav-item" onclick="app.showPage(2, this)">üîç<div class="nav-label"></div></div>
        <div class="nav-item" onclick="app.showPage(3, this)">üß∫;<div class="nav-label"></div></div>
        <div class="nav-item" onclick="app.showPage(4, this)">üçá<div class="nav-label"></div></div>
        <div class="nav-item" onclick="app.showPage(5, this)">üõí<div class="nav-label"></div></div>
        <div class="nav-item" onclick="app.showPage(6, this)">‚öôÔ∏è<div class="nav-label"></div></div>
    </div>

    <div id="wineModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle" style="font-family: 'Playfair Display'; margin-bottom: 20px;">Ajouter un vin</h2>
            <div class="form-group"><label>Code-barres (Scanner ou manuel)</label><input type="text" id="barcode"></div>
            <div class="form-group"><label>Nom du vin *</label><input type="text" id="wineName"></div>
            <div class="form-group">
                <label>Type</label>
                <select id="wineType" onchange="app.updateCepageList(this.value)">
                    <option value="Rouge">Rouge</option><option value="Blanc">Blanc</option><option value="Ros√©">Ros√©</option><option value="Mousseux">Mousseux</option>
                </select>
            </div>
            <div class="form-group"><label>Pays</label><select id="country" onchange="app.updateRegions()"></select></div>
            <div class="form-group"><label>R√©gion</label><select id="region"></select></div>
            <div class="form-group"><label>Appellation</label><input type="text" id="appellation"></div>
            <div class="form-group"><label>C√©pages</label><div class="checkbox-grid" id="cepageList"></div></div>
            <div class="form-group"><label>Accords mets</label><div class="checkbox-grid" id="accordList"></div></div>
            <div class="form-group"><label>Particularit√©</label><input type="text" id="particularity"></div>
            <div class="form-group"><label>Importateur</label><input type="text" id="importateur"></div>
            <div class="form-group"><label>Emplacements</label><div id="locationEntries"></div><button onclick="app.addLocationEntry()" style="width:100%; padding:10px;">+ Ajouter emplacement</button></div>
            <button onclick="app.saveWine()" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; margin-top:20px;">ENREGISTRER</button>
            <button onclick="app.closeWineModal()" style="width:100%; background:none; border:none; margin-top:10px;">Annuler</button>
        </div>
    </div>

    <div id="detailModal" class="modal"><div class="modal-content" id="wineDetail"></div></div>

    <div id="scanner">
        <div id="scannerVideo"></div>
        <div style="position: absolute; bottom: 40px; width: 100%; text-align: center;"><button onclick="app.stopScan()" style="padding:15px 40px; border-radius:30px; border:none; background:white; font-weight:bold;">FERMER</button></div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
    const app = {
        wines: JSON.parse(localStorage.getItem('wines')) || [],
        scanHistory: [],
        countries: ['France','Italie','Espagne','Portugal','Canada','√âtats-Unis','Argentine','Chili','Australie','Nouvelle-Z√©lande','Afrique du Sud','Allemagne'].sort(),
        regionsByCountry: {
            'France': ['Alsace','Beaujolais','Bordeaux','Bourgogne','Champagne','Corse','Jura','Languedoc','Loire','Provence','Rh√¥ne','Savoie','Sud-Ouest'],
            'Italie': ['Abruzzes','Calabre','Campanie','√âmilie-Romagne','Frioul','Latium','Ligurie','Lombardie','Marches','Ombrie','Pi√©mont','Pouilles','Sardaigne','Sicile','Toscane','V√©n√©tie'],
            'Canada': ['Qu√©bec','Ontario','Colombie-Britannique','Nouvelle-√âcosse'],
            'Espagne': ['Andalousie','Aragon','Castille','Catalogne','Galice','Rioja','Valence']
        },
        cepagesRouges: ['Cabernet Sauvignon','Cabernet Franc','Merlot','Pinot Noir','Syrah','Grenache','Mourv√®dre','Gamay','Malbec','Tempranillo','Sangiovese','Nebbiolo','Zinfandel','Barbera','Corvina','Saperavi'].sort(),
        cepagesBlancs: ['Chardonnay','Sauvignon Blanc','Riesling','Pinot Gris','Chenin Blanc','Viognier','Gewurztraminer','Muscat','Gr√ºner Veltliner','Aligot√©','Semillon','Melon de Bourgogne','Garganega','Cortese'].sort(),
        accordsMets: ['Ap√©ro','Poisson','Poulet','Grillades','P√¢tes sauce rouge','P√¢tes sauce blanche','Pizza','Fromages','Dessert','Asiatique','Indien','Fruits de mer','Agneau','Boeuf','Porc','Gibier','ZZZ - Ne pas racheter'].sort(),

        init() {
            this.initForm();
            this.updateHomePage();
            this.render();
        },

        initForm() {
            const cs = document.getElementById('country');
            cs.innerHTML = '<option value="">S√©lectionner</option>' + this.countries.map(c => `<option value="${c}">${c}</option>`).join('');
            const al = document.getElementById('accordList');
            al.innerHTML = this.accordsMets.map(a => `<label style="display:block"><input type="checkbox" value="${a}"> ${a}</label>`).join('');
            this.updateCepageList('Rouge');
            this.updateRegions();
        },

        updateCepageList(type) {
            const list = (type === 'Blanc' || type === 'Mousseux') ? this.cepagesBlancs : this.cepagesRouges;
            document.getElementById('cepageList').innerHTML = list.map(c => `<label style="display:block"><input type="checkbox" value="${c}"> ${c}</label>`).join('');
        },

        updateRegions() {
            const c = document.getElementById('country').value;
            const rs = document.getElementById('region');
            rs.innerHTML = '<option value="">S√©lectionner</option>';
            if(c && this.regionsByCountry[c]) this.regionsByCountry[c].forEach(r => rs.innerHTML += `<option value="${r}">${r}</option>`);
            rs.innerHTML += '<option value="Autre">Autre...</option>';
        },

        addLocationEntry(data = null) {
            const container = document.getElementById('locationEntries');
            const div = document.createElement('div');
            div.className = 'location-entry';
            div.innerHTML = `
                <select class="loc-cellier"><option value="1" ${data?.cellier=='1'?'selected':''}>Cellier 1</option><option value="2" ${data?.cellier=='2'?'selected':''}>Cellier 2</option><option value="3" ${data?.cellier=='3'?'selected':''}>Cellier 3</option></select>
                <input type="text" class="loc-tab" placeholder="Tab" value="${data?.tab||''}" style="width:60px">
                <input type="number" class="loc-qte" placeholder="Qt√©" value="${data?.qte||1}" style="width:60px">
                <button onclick="this.parentElement.remove()" style="color:red; background:none; border:none; float:right">Supprimer</button>
            `;
            container.appendChild(div);
        },

       quickScan() {
            this.scanHistory = [];
            const scannerEl = document.getElementById('scanner');
            scannerEl.classList.add('active');
            
            // D√©lai pour √©viter l'√©cran noir et laisser le DOM se mettre √† jour
            setTimeout(() => {
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: document.querySelector('#scannerVideo'),
                        constraints: {
                            facingMode: "environment"
                        },
                    },
                    locator: { patchSize: "medium", halfSample: true },
                    decoder: {
                        // Optimis√© : On ne cherche que les codes-barres de bouteilles
                        readers: ["ean_reader"] 
                    },
                    locate: true
                }, (err) => {
                    if (err) {
                        console.error(err);
                        alert("Erreur cam√©ra");
                        this.stopScan();
                        return;
                    }
                    Quagga.start();
                });
            }, 300);

            Quagga.offDetected();

            Quagga.onDetected((res) => {
                const code = res.codeResult.code;
                this.scanHistory.push(code);
                
                // Analyse de stabilit√© sur 6 √©chantillons
                if (this.scanHistory.length >= 6) {
                    const counts = {};
                    let maxOccurrences = 0;
                    let bestCode = null;

                    this.scanHistory.forEach(c => {
                        counts[c] = (counts[c] || 0) + 1;
                        if (counts[c] > maxOccurrences) {
                            maxOccurrences = counts[c];
                            bestCode = c;
                        }
                    });

                    // Si on a au moins 4 fois le m√™me code sur 6 lectures
                    if (maxOccurrences >= 4) {
                        this.stopScan();
                        this.handleValidScan(bestCode);
                    } else {
                        // Sinon on continue de chercher en retirant le plus vieux
                        this.scanHistory.shift();
                    }
                }
            });
        },

        stopScan() { 
            Quagga.stop(); 
            document.getElementById('scanner').classList.remove('active'); 
            this.scanHistory = [];
        },

        handleValidScan(code) {
            const existing = this.wines.find(w => w.barcode === code);
            
            if (existing) {
                this.showDetail(existing.id);
                this.showToast("Vin trouv√© dans la cave");
            } else {
                // 1. On ouvre d'abord la modale
                this.showWineModal();
                
                // 2. On attend 100ms que le HTML de la modale soit pr√™t
                setTimeout(() => {
                    const barcodeInput = document.getElementById('barcode');
                    if (barcodeInput) {
                        barcodeInput.value = code;
                        // Petit flash visuel pour confirmer
                        barcodeInput.style.backgroundColor = "#fff9c4"; 
                        setTimeout(() => barcodeInput.style.backgroundColor = "white", 800);
                        barcodeInput.focus();
                    } else {
                        console.error("L'√©l√©ment 'barcode' est introuvable");
                    }
                }, 150);

                this.showToast("Nouveau code : " + code);
            }
        },

        saveWine() {
            const name = document.getElementById('wineName').value;
            if(!name) return alert("Le nom est obligatoire");
            
            const locs = Array.from(document.querySelectorAll('.location-entry')).map(el => ({
                cellier: el.querySelector('.loc-cellier').value,
                tab: el.querySelector('.loc-tab').value,
                qte: parseInt(el.querySelector('.loc-qte').value) || 0
            }));

            const wine = {
                id: this.editingId || Date.now(),
                name: name,
                barcode: document.getElementById('barcode').value,
                type: document.getElementById('wineType').value,
                country: document.getElementById('country').value,
                region: document.getElementById('region').value,
                appellation: document.getElementById('appellation').value,
                cepages: Array.from(document.querySelectorAll('#cepageList input:checked')).map(c => c.value),
                accords: Array.from(document.querySelectorAll('#accordList input:checked')).map(c => c.value),
                particularity: document.getElementById('particularity').value,
                importateur: document.getElementById('importateur').value,
                locations: locs,
                quantity: locs.reduce((sum, l) => sum + l.qte, 0)
            };

            if(this.editingId) {
                const idx = this.wines.findIndex(w => w.id === this.editingId);
                this.wines[idx] = wine;
            } else {
                this.wines.push(wine);
            }

            localStorage.setItem('wines', JSON.stringify(this.wines));
            this.closeWineModal();
            this.updateHomePage();
            this.render();
            this.showToast("Sauvegard√© !");
        },

        showWineModal(id = null) {
            this.editingId = id;
            document.getElementById('wineModal').classList.add('active');
            document.getElementById('locationEntries').innerHTML = "";
            if(!id) {
                document.getElementById('barcode').value = "";
                document.getElementById('wineName').value = "";
                this.addLocationEntry();
            } else {
                const w = this.wines.find(x => x.id === id);
                document.getElementById('wineName').value = w.name;
                document.getElementById('barcode').value = w.barcode;
                document.getElementById('wineType').value = w.type;
                document.getElementById('country').value = w.country;
                this.updateRegions();
                document.getElementById('region').value = w.region;
                w.locations.forEach(l => this.addLocationEntry(l));
                // Restaurer les checkboxes
                document.querySelectorAll('#cepageList input').forEach(c => c.checked = w.cepages.includes(c.value));
                document.querySelectorAll('#accordList input').forEach(c => c.checked = w.accords.includes(c.value));
            }
        },

        closeWineModal() { document.getElementById('wineModal').classList.remove('active'); this.editingId = null; },

        updateHomePage() {
            const total = this.wines.reduce((sum, w) => sum + w.quantity, 0);
            document.getElementById('totalBottles').innerText = total;
        },

        showPage(n, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('page'+n).classList.add('active');
            el.classList.add('active');
        },

        render() {
            const q = document.getElementById('searchWine').value.toLowerCase();
            const type = document.getElementById('filterType').value;
            const wl = document.getElementById('wineList');
            const filtered = this.wines.filter(w => w.name.toLowerCase().includes(q) && (!type || w.type === type));
            wl.innerHTML = filtered.map(w => `
                <div class="wine-card" onclick="app.showDetail(${w.id})">
                    <div class="wine-name">${w.name}</div>
                    <div style="font-size:11px; color:#666">${w.country} | ${w.type} | Qt√©: ${w.quantity}</div>
                </div>
            `).join('');
        },

        showDetail(id) {
            const w = this.wines.find(x => x.id === id);
            document.getElementById('wineDetail').innerHTML = `
                <h2 style="font-family:'Playfair Display'">${w.name}</h2>
                <hr style="margin:10px 0">
                <p><strong>Pays:</strong> ${w.country} | <strong>R√©gion:</strong> ${w.region}</p>
                <p><strong>Type:</strong> ${w.type}</p>
                <p><strong>Code-barres:</strong> ${w.barcode || 'N/A'}</p>
                <div style="background:#f9f9f9; padding:10px; margin:10px 0">
                    <strong>Emplacements:</strong><br>
                    ${w.locations.map(l => `Cellier ${l.cellier}, Tab ${l.tab}: <b>${l.qte}</b>`).join('<br>')}
                </div>
                <button onclick="app.showWineModal(${w.id}); app.closeDetailModal();" style="width:100%; padding:12px; background:var(--primary); color:white; border:none;">MODIFIER</button>
                <button onclick="app.closeDetailModal()" style="width:100%; background:none; border:none; margin-top:10px;">FERMER</button>
            `;
            document.getElementById('detailModal').classList.add('active');
        },

        closeDetailModal() { document.getElementById('detailModal').classList.remove('active'); },

        showToast(m) {
            const t = document.getElementById('toast');
            t.innerText = m; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        },

        exportToJSON() {
            const blob = new Blob([JSON.stringify(this.wines)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'vino_backup.json'; a.click();
        },

        exportToExcel() {
            const data = this.wines.map(w => ({
                Nom: w.name, Type: w.type, Pays: w.country, R√©gion: w.region, 
                C√©pages: w.cepages.join(', '), Accords: w.accords.join(', '), Quantit√©: w.quantity, 'Code-barres': w.barcode
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Ma Cave");
            XLSX.writeFile(wb, "Vino_Export.xlsx");
        },

        handleImport(e) {
            const f = e.target.files[0];
            const r = new FileReader();
            r.onload = (ev) => {
                const im = JSON.parse(ev.target.result);
                if(confirm(`Importer ${im.length} vins?`)) { this.wines = im; localStorage.setItem('wines', JSON.stringify(this.wines)); location.reload(); }
            };
            r.readAsText(f);
        }
    };

    document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
