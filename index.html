<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VINO v2.4 - Version Finale Compl√®te</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* --- Styles identiques √† ton original --- */
        :root {
            --primary: #1E3A5F; --secondary: #D4AF37; --bg-light: #F8F6F3;
            --text-dark: #2C2C2C; --border: #E8E3DC;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Lato', sans-serif; }
        body { background: #000; color: var(--text-dark); padding-bottom: 80px; }
        body::before {
            content: ''; position: fixed; inset: 0; z-index: -1;
            background: linear-gradient(rgba(30,58,95,0.8), rgba(15,39,68,0.9)), url('https://images.unsplash.com/photo-1506377247377-2a5b3b0ca7df?q=80&w=2000');
            background-size: cover; background-position: center;
        }
        .header { background: rgba(30,58,95,0.9); padding: 20px; text-align: center; border-bottom: 2px solid var(--secondary); }
        .header h1 { font-family: 'Playfair Display', serif; color: var(--secondary); font-size: 36px; letter-spacing: 4px; }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        .page { display: none; } .page.active { display: block; }
        .nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(30,58,95,0.95); display: flex; padding: 10px; z-index: 100; border-top: 1px solid var(--secondary); }
        .nav-item { flex: 1; text-align: center; color: white; opacity: 0.6; cursor: pointer; font-size: 10px; }
        .nav-item.active { opacity: 1; color: var(--secondary); }
        .nav-item i { display: block; font-size: 20px; margin-bottom: 3px; }
        .wine-card { background: white; margin-bottom: 10px; padding: 15px; border-radius: 8px; border-left: 5px solid var(--primary); }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 500; overflow-y: auto; padding: 15px; }
        .modal.active { display: block; }
        .modal-content { background: white; padding: 20px; border-radius: 12px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid var(--border); border-radius: 6px; font-size: 16px; }
        .checkbox-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin: 10px 0; max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 10px; }
        .btn-add { background: var(--secondary); color: var(--primary-dark); border: none; padding: 15px; border-radius: 8px; font-weight: bold; width: 100%; }
        #scanner-ui { display: none; position: fixed; inset: 0; background: #000; z-index: 1000; }
        #scanner-ui.active { display: block; }
    </style>
</head>
<body>

    <div class="header"><h1>VINO</h1></div>

    <div class="container">
        <div id="page1" class="page active">
            <div style="text-align:center; color:white; margin: 40px 0;">
                <h2 style="font-size: 50px;" id="stat-total">0</h2>
                <p>BOUTEILLES</p>
                <button class="btn-add" onclick="app.startScan()" style="margin-top:20px; border-radius:50px; width:auto; padding:15px 40px;">üì∑ SCANNER</button>
            </div>
            <div id="home-cepages" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div>
        </div>

        <div id="page2" class="page">
            <input type="text" id="search-bar" placeholder="Rechercher un vin, pays..." onkeyup="app.render()">
            <div id="list-container"></div>
        </div>

        <div id="page6" class="page">
            <button class="btn-add" onclick="app.openModal()">‚ûï AJOUTER UN VIN</button>
            <button class="btn-add" onclick="app.exportExcel()" style="background:#eee; margin-top:10px;">üì§ EXCEL</button>
            <input type="file" id="import-file" style="margin-top:20px;" onchange="app.importData(event)">
        </div>
    </div>

    <div id="wine-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title">Nouveau Vin</h2>
            <input type="hidden" id="f-id">
            <input type="text" id="f-barcode" placeholder="Code-barres">
            <input type="text" id="f-name" placeholder="Nom du vin *">
            
            <label>Type</label>
            <select id="f-type" onchange="app.updateCepagesList()">
                <option value="Rouge">Rouge</option>
                <option value="Blanc">Blanc</option>
                <option value="Ros√©">Ros√©</option>
            </select>

            <label>Pays</label>
            <select id="f-country" onchange="app.updateRegions()"></select>
            
            <label>R√©gion</label>
            <select id="f-region"></select>

            <label>C√©pages</label>
            <div id="f-cepages" class="checkbox-group"></div>

            <label>Accords</label>
            <div id="f-accords" class="checkbox-group"></div>

            <div style="background:#f9f9f9; padding:10px; border-radius:8px;">
                <strong>Stocks par cellier :</strong>
                <div id="f-stocks"></div>
                <button type="button" onclick="app.addStockRow()">+ Cellier</button>
            </div>

            <button class="btn-add" onclick="app.save()" style="margin-top:20px;">ENREGISTRER</button>
            <button onclick="app.closeModal()" style="width:100%; border:none; background:none; padding:10px;">Annuler</button>
        </div>
    </div>

    <div id="scanner-ui">
        <div id="scanner-video" style="width:100%; height:80vh;"></div>
        <button onclick="app.stopScan()" style="width:100%; height:20vh; background:red; color:white; border:none; font-size:20px;">FERMER</button>
    </div>

    <div class="nav">
        <div class="nav-item active" onclick="app.nav(1, this)"><i>üè†</i>Accueil</div>
        <div class="nav-item" onclick="app.nav(2, this)"><i>üîç</i>Liste</div>
        <div class="nav-item" onclick="app.nav(6, this)"><i>‚öôÔ∏è</i>Gestion</div>
    </div>

    <script>
    const app = {
        wines: JSON.parse(localStorage.getItem('vins_v24')) || [],
        
        // --- DONN√âES DES LISTES D√âROULANTES ---
        config: {
            countries: ['France','Italie','Espagne','Portugal','Canada','√âtats-Unis','Australie','Argentine','Chili','Afrique du Sud','Allemagne','Autriche'].sort(),
            regions: {
                'France': ['Bordeaux','Bourgogne','Rh√¥ne','Loire','Provence','Languedoc','Alsace','Champagne','Jura','Savoie'],
                'Italie': ['Pi√©mont','Toscane','V√©n√©tie','Sicile','Pouilles','Abruzzes'],
                'Canada': ['Qu√©bec','Ontario','Colombie-Britannique']
            },
            cepages: {
                'Rouge': ['Cabernet Sauvignon','Merlot','Pinot Noir','Syrah','Grenache','Gamay','Malbec','Sangiovese','Nebbiolo','Tempranillo','Zinfandel'],
                'Blanc': ['Chardonnay','Sauvignon Blanc','Riesling','Pinot Gris','Chenin Blanc','Viognier','Gewurztraminer','Muscadet'],
                'Ros√©': ['Grenache','Cinsault','Syrah','Mourv√®dre','Pinot Noir']
            },
            accords: ['Ap√©ro','Poisson','Viande Rouge','Viande Blanche','P√¢tes','Fromage','Grillades','Dessert','Plat √âpic√©']
        },

        init() {
            this.populateSelect('f-country', this.config.countries);
            this.populateCheckboxes('f-accords', this.config.accords);
            this.updateCepagesList();
            this.updateRegions();
            this.render();
            this.updateStats();
        },

        // --- LOGIQUE INTERFACE ---
        populateSelect(id, list) {
            const el = document.getElementById(id);
            el.innerHTML = list.map(i => `<option value="${i}">${i}</option>`).join('');
        },

        populateCheckboxes(containerId, list) {
            const cont = document.getElementById(containerId);
            cont.innerHTML = list.map(i => `
                <label style="display:block; font-size:13px;">
                    <input type="checkbox" value="${i}"> ${i}
                </label>
            `).join('');
        },

        updateRegions() {
            const country = document.getElementById('f-country').value;
            const regions = this.config.regions[country] || ['Autre'];
            this.populateSelect('f-region', regions);
        },

        updateCepagesList() {
            const type = document.getElementById('f-type').value;
            this.populateCheckboxes('f-cepages', this.config.cepages[type] || []);
        },

        nav(num, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('page'+num).classList.add('active');
            el.classList.add('active');
        },

        // --- GESTION DES STOCKS ---
        addStockRow(data = {cellier:'1', qte:1}) {
            const div = document.createElement('div');
            div.className = "stock-row";
            div.style = "display:flex; gap:5px; margin-top:5px;";
            div.innerHTML = `
                <select class="s-cell" style="flex:2"><option value="1" ${data.cellier=='1'?'selected':''}>Cellier 1</option><option value="2" ${data.cellier=='2'?'selected':''}>Cellier 2</option><option value="3" ${data.cellier=='3'?'selected':''}>Cellier 3</option></select>
                <input type="number" class="s-qte" value="${data.qte}" style="flex:1">
                <button onclick="this.parentElement.remove()" style="color:red; border:none; background:none;">‚úï</button>
            `;
            document.getElementById('f-stocks').appendChild(div);
        },

        // --- SAUVEGARDE ET RENDU ---
        save() {
            const id = document.getElementById('f-id').value;
            const name = document.getElementById('f-name').value;
            if(!name) return alert("Nom requis");

            const stocks = Array.from(document.querySelectorAll('.stock-row')).map(r => ({
                cellier: r.querySelector('.s-cell').value,
                qte: parseInt(r.querySelector('.s-qte').value) || 0
            })).filter(s => s.qte > 0);

            const wine = {
                id: id || Date.now().toString(),
                name,
                barcode: document.getElementById('f-barcode').value,
                type: document.getElementById('f-type').value,
                country: document.getElementById('f-country').value,
                region: document.getElementById('f-region').value,
                cepages: Array.from(document.querySelectorAll('#f-cepages input:checked')).map(i => i.value),
                accords: Array.from(document.querySelectorAll('#f-accords input:checked')).map(i => i.value),
                stocks: stocks,
                total: stocks.reduce((a,b) => a + b.qte, 0)
            };

            if(id) {
                const idx = this.wines.findIndex(w => w.id === id);
                this.wines[idx] = wine;
            } else {
                this.wines.push(wine);
            }

            localStorage.setItem('vins_v24', JSON.stringify(this.wines));
            this.closeModal();
            this.render();
            this.updateStats();
        },

        render() {
            const query = document.getElementById('search-bar').value.toLowerCase();
            const cont = document.getElementById('list-container');
            const filtered = this.wines.filter(w => w.name.toLowerCase().includes(query) || w.country.toLowerCase().includes(query));
            
            cont.innerHTML = filtered.map(w => `
                <div class="wine-card" onclick="app.openModal('${w.id}')">
                    <strong>${w.name}</strong><br>
                    <small>${w.type} ‚Ä¢ ${w.country} ‚Ä¢ ${w.total} btl(s)</small>
                </div>
            `).join('');
        },

        updateStats() {
            const total = this.wines.reduce((a,b) => a + b.total, 0);
            document.getElementById('stat-total').innerText = total;
        },

        openModal(id = null) {
            document.getElementById('wine-modal').classList.add('active');
            document.getElementById('f-id').value = "";
            document.getElementById('f-stocks').innerHTML = "";
            if(id) {
                const w = this.wines.find(v => v.id === id);
                document.getElementById('f-id').value = w.id;
                document.getElementById('f-name').value = w.name;
                document.getElementById('f-barcode').value = w.barcode;
                document.getElementById('f-type').value = w.type;
                this.updateCepagesList();
                document.getElementById('f-country').value = w.country;
                this.updateRegions();
                document.getElementById('f-region').value = w.region;
                w.stocks.forEach(s => this.addStockRow(s));
                // Cocher les cases
                w.cepages.forEach(c => { const cb = document.querySelector(`#f-cepages input[value="${c}"]`); if(cb) cb.checked = true; });
            } else {
                this.addStockRow();
            }
        },

        closeModal() { document.getElementById('wine-modal').classList.remove('active'); },

        startScan() {
            document.getElementById('scanner-ui').classList.add('active');
            Quagga.init({
                inputStream: { name: "Live", type: "LiveStream", target: document.querySelector("#scanner-video") },
                decoder: { readers: ["ean_reader","upc_reader","code_128_reader"] }
            }, (err) => { if(!err) Quagga.start(); });
            Quagga.onDetected((res) => {
                this.stopScan();
                const code = res.codeResult.code;
                const exist = this.wines.find(w => w.barcode === code);
                if(exist) this.openModal(exist.id);
                else { this.openModal(); document.getElementById('f-barcode').value = code; }
            });
        },
        stopScan() { Quagga.stop(); document.getElementById('scanner-ui').classList.remove('active'); }
    };

    window.onload = () => app.init();
    </script>
</body>
</html>
