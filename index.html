<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>VINO v2.4 Premium</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Lato:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root {
            --primary: #1E3A5F;
            --primary-dark: #0F2744;
            --secondary: #D4AF37;
            --bg-light: #F8F6F3;
            --text-dark: #2C2C2C;
            --text-light: #6B6B6B;
            --border: #E8E3DC;
            --cellier1: #8B4513;
            --cellier2: #2F4F4F;
            --cellier3: #8B0000;
            --rouge: #800020;
            --blanc: #f3e5ab;
            --rose: #ffc0cb;
        }

        body {
            font-family: 'Lato', sans-serif;
            background-image: url('https://images.unsplash.com/photo-1506377247377-2a5b3b0ca7df?q=80&w=2070&auto=format&fit=crop');
            background-attachment: fixed;
            background-size: cover;
            background-position: center;
            color: var(--text-dark);
            min-height: 100vh;
        }

        .header {
            background: rgba(30, 58, 95, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px;
            text-align: center;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 { font-family: 'Playfair Display', serif; font-size: 32px; color: var(--secondary); letter-spacing: 4px; }
        .version { font-size: 10px; opacity: 0.7; }

        .container { max-width: 1200px; margin: 0 auto; padding-bottom: 100px; }

        .page {
            display: none;
            padding: 20px;
            background: rgba(248, 246, 243, 0.92);
            min-height: calc(100vh - 60px);
            backdrop-filter: blur(5px);
        }
        .page.active { display: block; }

        /* Cartes de vin avec bordures */
        .wine-card {
            background: white;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 8px solid var(--primary);
        }
        .card-rouge { border-left-color: var(--rouge) !important; }
        .card-blanc { border-left-color: var(--blanc) !important; }
        .card-rose { border-left-color: var(--rose) !important; }

        .filter-bar { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 16px; }

        .btn-primary { background: var(--primary); color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; font-weight: 600; cursor: pointer; margin-bottom: 10px; }
        .btn-secondary { background: white; color: var(--primary); border: 1.5px solid var(--primary); padding: 12px; width: 100%; border-radius: 8px; font-weight: 600; margin-bottom: 10px; }

        .nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; display: flex; justify-content: space-around;
            padding: 10px 0 calc(10px + env(safe-area-inset-bottom));
            box-shadow: 0 -2px 15px rgba(0,0,0,0.1); z-index: 1000;
        }
        .nav-item { flex: 1; text-align: center; color: var(--text-light); font-size: 10px; text-transform: uppercase; font-weight: 600; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 2px; }

        #scanner { display: none; position: fixed; inset: 0; background: black; z-index: 2000; }
        #scanner.active { display: block; }
        #scannerVideo { width: 100%; height: 80%; object-fit: cover; }

        .toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 12px 24px; border-radius: 30px; z-index: 3000; display: none; }
        
        /* Stats Styles */
        .total-bottles { font-family: 'Playfair Display', serif; font-size: 50px; color: var(--primary); font-weight: 700; text-align: center; }
        .grape-summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
        .grape-card { background: var(--primary); color: white; padding: 10px; border-radius: 50%; aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; text-align: center; }
    </style>
</head>
<body>

<div id="toast" class="toast"></div>

<div class="header">
    <div class="version">V2.4 PREMIUM - 2026</div>
    <h1>VINO</h1>
</div>

<div class="container">
    <div id="page1" class="page active">
        <div style="text-align: center; padding: 20px 0;">
            <div class="total-bottles" id="mainTotal">0</div>
            <p style="text-transform: uppercase; letter-spacing: 2px; font-size: 12px; margin-bottom: 30px;">Bouteilles en cave</p>
            <button class="btn-primary" onclick="app.startScan()">üì∑ SCANNER CODE-BARRES</button>
            <button class="btn-secondary" onclick="app.openModal()">‚ûï AJOUT MANUEL</button>
        </div>
        <div class="grape-summary-grid" id="grapeStats"></div>
    </div>

    <div id="page2" class="page">
        <div class="filter-bar">
            <button class="btn-secondary" onclick="app.resetFilters()" style="padding: 8px; font-size: 12px;">üîÑ R√âINITIALISER FILTRES</button>
            <select id="fType" onchange="app.renderList()">
                <option value="">Tous les types</option>
                <option value="Rouge">Rouge</option>
                <option value="Blanc">Blanc</option>
                <option value="Ros√©">Ros√©</option>
            </select>
            <input type="text" id="fSearch" placeholder="Rechercher nom, pays, r√©gion..." onkeyup="app.renderList()">
        </div>
        <div id="listOutput"></div>
    </div>

    <div id="page3" class="page">
        <h2>Mes Celliers</h2>
        <select id="cellierViewSelect" onchange="app.renderCellierView()"></select>
        <div id="cellierContent"></div>
    </div>

    <div id="page4" class="page">
        <h2>C√©pages & Types</h2>
        <div id="cepageContent"></div>
    </div>

    <div id="page5" class="page">
        <h2>Liste d'achats</h2>
        <div id="shoppingContent"></div>
    </div>

    <div id="page6" class="page">
        <h2>Gestion & Import</h2>
        <button class="btn-secondary" onclick="app.exportData()">üìä EXPORTER (EXCEL)</button>
        <button class="btn-secondary" onclick="document.getElementById('importTrigger').click()">üì• IMPORTER (JSON/EXCEL)</button>
        <input type="file" id="importTrigger" style="display:none" onchange="app.handleImport(event)">
        <button class="btn-secondary" style="border-color: #dc2626; color: #dc2626; margin-top: 50px;" onclick="app.clearAll()">‚ö†Ô∏è EFFACER TOUTE LA CAVE</button>
    </div>
</div>

<nav class="nav">
    <div class="nav-item active" onclick="app.showPage(1, this)"><span class="nav-icon">üè†</span>Accueil</div>
    <div class="nav-item" onclick="app.showPage(2, this)"><span class="nav-icon">üîç</span>Liste</div>
    <div class="nav-item" onclick="app.showPage(3, this)"><span class="nav-icon">üçæ</span>Celliers</div>
    <div class="nav-item" onclick="app.showPage(4, this)"><span class="nav-icon">üçá</span>C√©pages</div>
    <div class="nav-item" onclick="app.showPage(5, this)"><span class="nav-icon">üõí</span>Achats</div>
    <div class="nav-item" onclick="app.showPage(6, this)"><span class="nav-icon">‚öôÔ∏è</span>Gestion</div>
</nav>

<div id="scanner">
    <div id="scannerVideo"></div>
    <button class="btn-secondary" onclick="app.stopScan()" style="position: absolute; bottom: 40px; left: 10%; width: 80%;">ANNULER</button>
</div>

<script>
const app = {
    wines: JSON.parse(localStorage.getItem('vino_db')) || [],
    scannerActive: false,

    init() {
        this.updateStats();
        this.renderList();
        // Initialiser les noms de celliers dynamiques
        const celliers = [...new Set(this.wines.flatMap(w => (w.locations || []).map(l => l.zone)))];
        const sel = document.getElementById('cellierViewSelect');
        sel.innerHTML = '<option value="">Choisir un cellier</option>' + 
            celliers.map(c => `<option value="${c}">${c}</option>`).join('');
    },

    save() {
        localStorage.setItem('vino_db', JSON.stringify(this.wines));
        this.updateStats();
    },

    showPage(n, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById('page'+n).classList.add('active');
        el.classList.add('active');
        if(n === 1) this.updateStats();
        if(n === 2) this.renderList();
    },

    updateStats() {
        let total = 0;
        let grapes = {};
        this.wines.forEach(w => {
            const qty = w.locations ? w.locations.length : (parseInt(w.quantity) || 0);
            total += qty;
            if(w.type) grapes[w.type] = (grapes[w.type] || 0) + qty;
        });
        document.getElementById('mainTotal').textContent = total;
        
        const grid = document.getElementById('grapeStats');
        grid.innerHTML = Object.entries(grapes).map(([type, count]) => `
            <div class="grape-card">
                <div style="font-weight:bold; font-size:16px">${count}</div>
                <div>${type}</div>
            </div>
        `).join('');
    },

    renderList() {
        const query = document.getElementById('fSearch').value.toLowerCase();
        const typeF = document.getElementById('fType').value;
        const container = document.getElementById('listOutput');
        container.innerHTML = '';

        const filtered = this.wines.filter(w => {
            const matchTxt = w.name.toLowerCase().includes(query) || (w.country && w.country.toLowerCase().includes(query));
            const matchTyp = !typeF || w.type === typeF;
            return matchTxt && matchTyp;
        });

        filtered.forEach(w => {
            const div = document.createElement('div');
            let tCls = '';
            if(w.type === 'Rouge') tCls = 'card-rouge';
            else if(w.type === 'Blanc') tCls = 'card-blanc';
            else if(w.type === 'Ros√©') tCls = 'card-rose';
            
            div.className = `wine-card ${tCls}`;
            const qty = w.locations ? w.locations.length : w.quantity;
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:start;">
                    <div>
                        <div style="font-family:'Playfair Display'; font-weight:700; font-size:18px;">${w.name}</div>
                        <div style="font-size:12px; color:var(--text-light); text-transform:uppercase;">${w.type} | ${w.country || 'N/A'}</div>
                    </div>
                    <div style="background:var(--bg-light); padding:5px 10px; border-radius:4px; font-weight:bold;">${qty}</div>
                </div>
            `;
            container.appendChild(div);
        });
    },

    resetFilters() {
        document.getElementById('fSearch').value = '';
        document.getElementById('fType').value = '';
        this.renderList();
    },

    // SCANNER LOGIQUE
    startScan() {
        this.scannerActive = true;
        document.getElementById('scanner').classList.add('active');
        Quagga.init({
            inputStream: { name: "Live", type: "LiveStream", target: document.getElementById('scannerVideo') },
            decoder: { readers: ["ean_reader", "upc_reader", "code_128_reader"] }
        }, (err) => {
            if (err) { alert(err); return; }
            Quagga.start();
        });

        Quagga.onDetected((data) => {
            if(this.scannerActive) {
                const code = data.codeResult.code;
                this.stopScan();
                this.handleScanResult(code);
            }
        });
    },

    stopScan() {
        this.scannerActive = false;
        Quagga.stop();
        document.getElementById('scanner').classList.remove('active');
    },

    handleScanResult(code) {
        const wine = this.wines.find(w => w.barcode === code);
        if(wine) {
            this.showPage(2, document.querySelectorAll('.nav-item')[1]);
            document.getElementById('fSearch').value = wine.name;
            this.renderList();
        } else {
            alert("Nouveau code d√©tect√© : " + code + ". Ouvrez le formulaire d'ajout.");
        }
    },

    // IMPORT / EXPORT
    handleImport(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                const imported = JSON.parse(ev.target.result);
                const mode = confirm(`Fusionner ${imported.length} vins ? (OK = Fusionner / Annuler = Remplacer)`);
                if(mode) {
                    imported.forEach(newW => {
                        if(!this.wines.some(w => w.name === newW.name)) this.wines.push(newW);
                    });
                } else {
                    this.wines = imported;
                }
                this.save();
                this.showPage(1, document.querySelectorAll('.nav-item')[0]);
                this.showToast("Importation r√©ussie");
            } catch(err) { alert("Erreur de fichier"); }
        };
        reader.readAsText(file);
    },

    showToast(m) {
        const t = document.getElementById('toast');
        t.textContent = m; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2500);
    },

    clearAll() {
        if(confirm("VOULEZ-VOUS VRAIMENT TOUT SUPPRIMER ?")) {
            this.wines = [];
            this.save();
            location.reload();
        }
    }
};

app.init();
</script>

</body>
</html>

