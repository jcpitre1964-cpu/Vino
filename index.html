<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VINO - Gestion de Cave</title>
    <style>
        :root {
            --primary: #002b5c; --secondary: #6d071a; --accent: #d4af37;
            --bg: #0a0a0a; --card-bg: #1a1a1a; --text: #ffffff;
            --text-light: #a0a0a0; --border: #333;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), 
                        url('https://images.unsplash.com/photo-1510812431401-41d2bd2722f3?auto=format&fit=crop&w=800&q=80');
            background-size: cover;  text-align: center; border-bottom: 2px solid var(--accent);  }

        .header { 
            background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), 
                        url('https://images.unsplash.com/photo-1510812431401-41d2bd2722f3?auto=format&fit=crop&w=800&q=80');
            background-size: cover; padding: 40px 20px; text-align: center; border-bottom: 2px solid var(--accent); 
        }
        .version { font-size: 10px; color: var(--accent); letter-spacing: 2px; margin-bottom: 5px; }
        h1 { font-size: 32px; letter-spacing: 5px; margin: 10px 0; font-weight: 300; }
        .subtitle { font-size: 12px; color: var(--text-light); text-transform: uppercase; letter-spacing: 2px; }

        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        
        .page { display: none; }
        .page.active { display: block; }

        .home-stats { text-align: center; margin-bottom: 30px; }
        .total-bottles { font-size: 64px; color: var(--accent); font-weight: bold; display: block; line-height: 1; }
        .total-label { text-transform: uppercase; font-size: 12px; color: var(--text-light); letter-spacing: 2px; }

        .scan-buttons { display: flex; justify-content: center; gap: 40px; margin: 30px 0; }
        .btn-circle { width: 80px; height: 80px; border-radius: 50%; border: none; background: var(--primary); color: white; font-size: 30px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; }
        .scan-label { margin-top: 10px; font-size: 12px; color: var(--text-light); text-align: center; }

        .grape-summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .grape-summary-card { background: var(--card-bg); padding: 15px; border-radius: 10px; border-left: 3px solid var(--accent); }
        .grape-summary-name { font-size: 12px; color: var(--text-light); text-transform: uppercase; }
        .grape-summary-count { font-size: 20px; font-weight: bold; color: var(--accent); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; overflow-y: auto; }
        .modal-content { padding: 25px; max-width: 500px; margin: 0 auto; }
        label { display: block; font-size: 11px; color: var(--accent); text-transform: uppercase; margin-bottom: 5px; letter-spacing: 1px; }
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 15px; background: #222; border: 1px solid var(--border); color: white; border-radius: 8px; }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        .cepage-grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; background: #111; padding: 10px; border-radius: 8px; max-height: 150px; overflow-y: auto; margin-bottom: 15px; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; font-size: 13px; }
        
        .location-entry { background: #252525; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: flex; gap: 5px; }
        .location-entry select { margin-bottom: 0; flex: 1; }

        .nav { position: fixed; bottom: 0; width: 100%; background: #000; display: flex; border-top: 1px solid var(--border); padding: 10px 0; z-index: 100; }
        .nav-item { flex: 1; text-align: center; color: var(--text-light); font-size: 9px; text-transform: uppercase; cursor: pointer; }
        .nav-item.active { color: var(--accent); }
        .nav-item div { font-size: 18px; margin-bottom: 3px; }

        .wine-card { background: var(--card-bg); padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .btn-save { background: var(--primary); color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        .btn-list-saq, .btn-form-saq { background: var(--accent); color: black; text-decoration: none; padding: 5px 10px; border-radius: 5px; font-size: 10px; font-weight: bold; text-align: center; }
        .btn-form-saq { display: block; margin-bottom: 15px; padding: 10px; }
    </style>
</head>
<body>

<div class="header">
    <div class="version">910</div>
    <h1>VINO</h1>
    <div class="subtitle">Collections Priv√©e</div>
</div>

<div class="container">
    <div id="page1" class="page active">
        <div class="home-stats">
            <span class="total-bottles" id="totalBottles">0</span>
            <span class="total-label">bouteilles au total</span>
        </div>
        <div class="scan-buttons">
            <div onclick="alert('Scanner activ√©')">
                <div class="btn-circle">üì∑</div>
                <div class="scan-label">Scanner</div>
            </div>
            <div onclick="showWineModal()">
                <div class="btn-circle" style="background: var(--secondary);">‚å®Ô∏è</div>
                <div class="scan-label">Ajouter</div>
            </div>
        </div>
        <div class="grape-summary-grid" id="grapeSummaryGrid"></div>
    </div>

    <div id="page2" class="page">
        <input type="text" id="searchWine" placeholder="Rechercher un vin..." onkeyup="render()">
        <div id="wineList"></div>
    </div>

    <div id="page3" class="page"><h2>Cellier Visuel</h2></div>
    <div id="page4" class="page"><h2>C√©pages & Stats</h2></div>
    <div id="page5" class="page"><h2>Liste d'achats</h2></div>
    <div id="page6" class="page">
        <h2>Outils</h2>
        <button onclick="localStorage.clear(); location.reload();" style="background:red; color:white; padding:10px; border:none; margin-top:20px; border-radius:5px;">R√©initialiser la base</button>
    </div>
</div>

<div id="wineModal" class="modal">
    <div class="modal-content">
        <h2 id="modalTitle" style="margin-bottom:20px; font-weight:300;">Ajouter un vin</h2>
        <form id="wineForm" onsubmit="saveWine(event)">
            <label>Nom du vin *</label>
            <input type="text" id="wineName" required>

            <div class="row">
                <div><label>Code-Barres</label><input type="text" id="barcode"></div>
                <div>
                    <label>Type *</label>
                    <select id="wineType" onchange="updateCepageList(this.value)" required>
                        <option value="">Choisir...</option>
                        <option value="Rouge">Rouge</option>
                        <option value="Blanc">Blanc</option>
                        <option value="Ros√©">Ros√©</option>
                        <option value="Mousseux">Mousseux</option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div><label>Pays</label><select id="country" onchange="updateRegions()"></select></div>
                <div><label>R√©gion</label><select id="region"></select></div>
            </div>

            <label>Accords Mets</label>
            <select id="foodPairing">
                <option value="">Choisir un accord...</option>
                <option value="Viande Rouge">Viande Rouge</option>
                <option value="Poisson">Poisson</option>
                <option value="Volaille">Volaille</option>
                <option value="Fromages">Fromages</option>
                <option value="P√¢tes">P√¢tes</option>
                <option value="Dessert">Dessert</option>
            </select>

            <label>URL SAQ</label>
            <input type="text" id="saqUrl" placeholder="https://www.saq.com/...">
            <a href="javascript:void(0)" onclick="openSaqFromForm()" class="btn-form-saq" id="btnFormSaq">VOIR SUR SAQ.COM</a>

            <label>C√©pages</label>
            <div id="cepageList" class="cepage-grid-container"></div>

            <label>Emplacements</label>
            <div id="locationEntries"></div>
            <button type="button" onclick="addLocationEntry()" style="background:#333; color:white; border:none; padding:10px; width:100%; border-radius:8px; margin-bottom:20px;">+ Ajouter une bouteille</button>

            <button type="submit" class="btn-save">ENREGISTRER</button>
            <button type="button" onclick="closeWineModal()" style="background:none; border:none; color:gray; width:100%; margin-top:10px;">Annuler</button>
        </form>
    </div>
</div>

<div class="nav">
    <div class="nav-item active" onclick="showPage(1)"><div>üç∑</div>Accueil</div>
    <div class="nav-item" onclick="showPage(2)"><div>üîç</div>Liste</div>
    <div class="nav-item" onclick="showPage(3)"><div>üì¶</div>Cellier</div>
    <div class="nav-item" onclick="showPage(4)"><div>üçá</div>C√©pages</div>
    <div class="nav-item" onclick="showPage(5)"><div>üõí</div>Achats</div>
    <div class="nav-item" onclick="showPage(6)"><div>‚öôÔ∏è</div>Outils</div>
</div>

<script>
    let wines = JSON.parse(localStorage.getItem('wines')) || [];
    let editingId = null;

    const countries = ['France', 'Italie', 'Espagne', 'Portugal', 'Canada', '√âtats-Unis'].sort();
    const regionsByCountry = { 'France': ['Bordeaux', 'Bourgogne', 'Rh√¥ne'], 'Canada': ['Qu√©bec', 'Ontario'] };
    const cepagesBlancs = ['Chardonnay', 'Sauvignon Blanc', 'Riesling'];
    const cepagesRouges = ['Cabernet Sauvignon', 'Pinot Noir', 'Merlot'];

    window.onload = () => { populateCountries(); updateHomePage(); showPage(1); };

    function showPage(n) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById('page' + n).classList.add('active');
        document.querySelectorAll('.nav-item')[n-1].classList.add('active');
        if(n === 2) render();
    }

    function openSaqFromForm() {
        const url = document.getElementById('saqUrl').value;
        if(url) window.open(url, '_blank');
        else alert("Veuillez d'abord coller un lien SAQ.");
    }

    function populateCountries() {
        const el = document.getElementById('country');
        el.innerHTML = '<option value="">Choisir...</option>';
        countries.forEach(c => el.add(new Option(c, c)));
    }

    function updateRegions() {
        const c = document.getElementById('country').value;
        const r = document.getElementById('region');
        r.innerHTML = '<option value="">R√©gion...</option>';
        if(regionsByCountry[c]) regionsByCountry[c].forEach(reg => r.add(new Option(reg, reg)));
    }

    function updateCepageList(type) {
        const container = document.getElementById('cepageList');
        container.innerHTML = '';
        const list = (type === 'Blanc' || type === 'Mousseux') ? cepagesBlancs : (type === 'Rouge' ? cepagesRouges : [...cepagesBlancs, ...cepagesRouges]);
        list.forEach(c => {
            container.innerHTML += `<div class="checkbox-item"><input type="checkbox" id="cep_${c}" value="${c}"><label for="cep_${c}">${c}</label></div>`;
        });
    }

    function addLocationEntry(data = {zone:'1', rangee:'1', espace:'A'}) {
        const div = document.createElement('div');
        div.className = 'location-entry';
        div.innerHTML = `
            <select class="loc-z"><option value="1" ${data.zone=='1'?'selected':''}>Cellier</option><option value="2" ${data.zone=='2'?'selected':''}>Casiers</option><option value="3" ${data.zone=='3'?'selected':''}>R√©serve</option></select>
            <select class="loc-r">${Array.from({length:10},(_,i)=>`<option value="${i+1}" ${data.rangee==i+1?'selected':''}>R${i+1}</option>`).join('')}</select>
            <select class="loc-e">${"ABCDEFGHIJ".split('').map(e => `<option value="${e}" ${data.espace==e?'selected':''}>${e}</option>`).join('')}</select>
            <button type="button" onclick="this.parentElement.remove()" style="background:none; border:none; color:red; font-weight:bold;">‚úï</button>
        `;
        document.getElementById('locationEntries').appendChild(div);
    }

    function showWineModal(id = null) {
        editingId = id;
        document.getElementById('wineForm').reset();
        document.getElementById('locationEntries').innerHTML = '';
        document.getElementById('wineModal').style.display = 'block';
        if(id) {
            const w = wines.find(x => x.id === id);
            document.getElementById('modalTitle').innerText = "Modifier le vin";
            document.getElementById('wineName').value = w.name;
            document.getElementById('wineType').value = w.type;
            document.getElementById('saqUrl').value = w.saqUrl || '';
            document.getElementById('foodPairing').value = w.foodPairing || '';
            updateCepageList(w.type);
            w.cepages.forEach(c => { if(document.getElementById('cep_'+c)) document.getElementById('cep_'+c).checked = true; });
            w.locations.forEach(l => addLocationEntry(l));
        } else {
            document.getElementById('modalTitle').innerText = "Ajouter un vin";
            updateCepageList('');
            addLocationEntry();
        }
    }

    function saveWine(e) {
        e.preventDefault();
        const locs = [];
        const entries = document.querySelectorAll('.location-entry');
        
        // --- VERIFICATION DOUBLON EMPLACEMENT ---
        for (let entry of entries) {
            const z = entry.querySelector('.loc-z').value;
            const r = entry.querySelector('.loc-r').value;
            const es = entry.querySelector('.loc-e').value;
            
            const occupant = wines.find(w => w.id !== editingId && w.locations.some(l => l.zone === z && l.rangee === r && l.espace === es));
            
            if(occupant) {
                alert(`ERREUR : L'emplacement Zone ${z} / Rang ${r} / Espace ${es} est d√©j√† occup√© par le vin : "${occupant.name}".`);
                return; // Bloque l'enregistrement
            }
            locs.push({ zone: z, rangee: r, espace: es });
        }

        const data = {
            id: editingId || Date.now(),
            name: document.getElementById('wineName').value,
            type: document.getElementById('wineType').value,
            country: document.getElementById('country').value,
            foodPairing: document.getElementById('foodPairing').value,
            saqUrl: document.getElementById('saqUrl').value,
            cepages: Array.from(document.querySelectorAll('#cepageList input:checked')).map(cb => cb.value),
            locations: locs
        };

        if(editingId) wines = wines.map(w => w.id === editingId ? data : w);
        else wines.push(data);
        
        localStorage.setItem('wines', JSON.stringify(wines));
        closeWineModal();
        updateHomePage();
    }

    function render() {
        const s = document.getElementById('searchWine').value.toLowerCase();
        document.getElementById('wineList').innerHTML = wines.filter(w => w.name.toLowerCase().includes(s)).map(w => `
            <div class="wine-card">
                <div onclick="showWineModal(${w.id})" style="flex:1">
                    <strong>${w.name}</strong><br><small>${w.type} ‚Ä¢ ${w.country}</small>
                </div>
                <div style="display:flex; align-items:center;">
                    <span style="color:var(--accent); font-weight:bold; margin-right:10px;">${w.locations.length}</span>
                    ${w.saqUrl ? `<a href="${w.saqUrl}" target="_blank" class="btn-list-saq">SAQ</a>` : ''}
                </div>
            </div>
        `).join('');
    }

    function updateHomePage() {
        let total = 0; let counts = {};
        wines.forEach(w => {
            total += w.locations.length;
            w.cepages.forEach(c => counts[c] = (counts[c] || 0) + w.locations.length);
        });
        document.getElementById('totalBottles').innerText = total;
        document.getElementById('grapeSummaryGrid').innerHTML = Object.entries(counts).sort((a,b)=>b[1]-a[1]).map(([name, count]) => `
            <div class="grape-summary-card"><div class="grape-summary-name">${name}</div><div class="grape-summary-count">${count}</div></div>
        `).join('');
    }

    function closeWineModal() { document.getElementById('wineModal').style.display = 'none'; }
</script>
</body>
</html>
