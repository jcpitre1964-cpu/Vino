<!DOCTYPE html>

<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>VINO</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Lato:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }


    :root {
        --primary: #1E3A5F;
        --primary-dark: #0F2744;
        --secondary: #D4AF37;
        --bg-light: #F8F6F3;
        --text-dark: #2C2C2C;
        --text-light: #6B6B6B;
        --border: #E8E3DC;
        --cellier1: #8B4513;
        --cellier2: #2F4F4F;
        --cellier3: #8B0000;
    }
    
    body {
        font-family: 'Lato', sans-serif;
        background: #000;
        color: var(--text-dark);
        padding-bottom: 80px;
        position: relative;
        min-height: 100vh;
    }
    
    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
       
    }
    
    .header {
        background: rgba(30, 58, 95, 0.95);
        backdrop-filter: blur(10px);
        padding: 16px 20px;
        text-align: center;
        box-shadow: 0 2px 20px rgba(0,0,0,0.3);
        position: relative;
    }
    
    .version {
        position: absolute;
        top: 8px;
        right: 12px;
        font-size: 9px;
        color: rgba(255, 255, 255, 0.5);
        font-weight: 300;
    }
    
    .header h1 {
        font-family: 'Playfair Display', serif;
        font-size: 52px;
        font-weight: 700;
        color: var(--secondary);
        letter-spacing: 8px;
        margin-bottom: 2px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .subtitle {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.8);
        letter-spacing: 3px;
        text-transform: uppercase;
        font-weight: 300;
    }
    
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .page {
        display: none;
    }
    
    .page.active {
        display: block;
    }
    
    .nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(30, 58, 95, 0.98);
        backdrop-filter: blur(15px);
        display: flex;
        justify-content: space-around;
        padding: 8px 0 max(8px, env(safe-area-inset-bottom));
        box-shadow: 0 -2px 20px rgba(0,0,0,0.3);
        z-index: 100;
    }
    
    .nav-item {
        flex: 1;
        text-align: center;
        color: rgba(255, 255, 255, 0.6);
        padding: 8px 4px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 20px;
        position: relative;
    }
    
    .nav-item.active {
        color: var(--secondary);
    }
    
    .nav-item .nav-label {
        font-size: 9px;
        margin-top: 2px;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        font-weight: 400;
    }
    
    .scan-hero {
        text-align: center;
        padding: 60px 20px 40px;
    }
    
    .scan-buttons {
        display: flex;
        justify-content: center;
        gap: 40px;
        margin-top: 30px;
    }
    
    .btn-scan-large {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        font-size: 52px;
        cursor: pointer;
        box-shadow: 0 8px 30px rgba(30, 58, 95, 0.4);
        transition: all 0.3s;
    }
    
    .btn-scan-large:active {
        transform: scale(0.95);
    }
    
    .scan-label {
        margin-top: 12px;
        font-size: 13px;
        color: rgba(255, 255, 255, 0.9);
        font-weight: 600;
        letter-spacing: 1px;
    }
    
    .filter-bar {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 16px;
        border-radius: 0;
        margin-bottom: 16px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .filter-bar select,
    .filter-bar input {
        width: 100%;
        padding: 12px;
        margin-bottom: 10px;
        border: 1px solid var(--border);
        border-radius: 0;
        font-size: 14px;
        background: white;
    }
    
    .cepage-filter-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin-bottom: 12px;
    }
    
    .cepage-filter-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
    }
    
    .cepage-filter-item input[type="checkbox"] {
        width: auto;
        margin: 0;
    }
    
    .wine-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 16px;
        margin-bottom: 12px;
        border-radius: 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: all 0.2s;
        border-left: 4px solid var(--primary);
    }
    
    .wine-card:active {
        transform: scale(0.98);
    }
    
    .wine-name {
        font-family: 'Playfair Display', serif;
        font-size: 18px;
        font-weight: 600;
        color: var(--primary);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .wine-info {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        font-size: 12px;
        color: var(--text-light);
    }
    
    .badge {
        background: var(--bg-light);
        padding: 4px 10px;
        border-radius: 0;
        font-size: 11px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    
    .wine-location {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 0;
        font-size: 11px;
        font-weight: 600;
        color: white;
        margin-right: 6px;
        margin-bottom: 6px;
    }
    
    .cellier-1 { background: var(--cellier1); }
    .cellier-2 { background: var(--cellier2); }
    .cellier-3 { background: var(--cellier3); }
    
    .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 200;
        overflow-y: auto;
        padding: 20px;
    }
    
    .modal.active {
        display: flex;
        align-items: flex-start;
        justify-content: center;
    }
    
    .modal-content {
        background: white;
        border-radius: 0;
        padding: 24px;
        max-width: 600px;
        width: 100%;
        margin: 20px auto;
        box-shadow: 0 10px 50px rgba(0,0,0,0.3);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--border);
    }
    
    .modal-title {
        font-family: 'Playfair Display', serif;
        font-size: 24px;
        font-weight: 600;
        color: var(--primary);
    }
    
    .close-btn {
        background: none;
        border: none;
        font-size: 32px;
        color: var(--text-light);
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        line-height: 1;
    }
    
    .form-group {
        margin-bottom: 16px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        font-size: 13px;
        color: var(--text-dark);
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 0;
        font-size: 14px;
        font-family: 'Lato', sans-serif;
    }
    
    .form-group textarea {
        resize: vertical;
        min-height: 80px;
    }
    
    .checkbox-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--border);
        padding: 12px;
        background: var(--bg-light);
    }
    
    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
    }
    
    .checkbox-item input[type="checkbox"] {
        width: auto;
        margin: 0;
    }
    
    .btn-primary,
    .btn-secondary,
    .btn-danger {
        width: 100%;
        padding: 14px;
        border: none;
        border-radius: 0;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(30, 58, 95, 0.3);
    }
    
    .btn-primary:active {
        transform: translateY(2px);
    }
    
    .btn-secondary {
        background: white;
        color: var(--primary);
        border: 2px solid var(--primary);
        margin-bottom: 10px;
    }
    
    .btn-danger {
        background: #dc2626;
        color: white;
    }
    
    .btn-icon {
        width: auto;
        padding: 10px 20px;
        font-size: 13px;
    }
    
    .location-btn {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 0;
        background: #ef4444;
        color: white;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        margin: 0;
        line-height: 1;
    }
    
    .location-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
    }
    
    .location-entry {
        background: rgba(255, 255, 255, 0.95);
        padding: 10px;
        border-radius: 0;
        margin-bottom: 8px;
        border: 1px solid var(--border);
    }
    
    .location-entry-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
        margin-top: 6px;
    }
    
   /* Le conteneur qui s'affiche par-dessus tout */
#scanner {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: #000;
    z-index: 9999;
    display: none; /* Cach√© par d√©faut */
}

/* La vid√©o elle-m√™me */
#scannerVideo video {
    width: 100vw;
    height: 100vh;
    object-fit: cover;
}

/* La ligne rouge de guidage */
.line-guide {
    position: absolute;
    top: 50%;
    left: 10%;
    right: 10%;
    height: 2px;
    background: red;
    box-shadow: 0 0 10px red;
    z-index: 10000;
    pointer-events: none; /* Pour ne pas g√™ner le clic */
}

/* Bouton pour fermer le scan */
.btn-close-scan {
    position: absolute;
    top: 20px;
    right: 20px;
    z-index: 10001;
    padding: 10px 20px;
    background: rgba(0,0,0,0.5);
    color: white;
    border: 1px solid white;
    border-radius: 5px;
}

    
    #scanner .controls {
        position: absolute;
        bottom: 40px;
        left: 50%;
        transform: translateX(-50%);
    }
    
    .empty {
        text-align: center;
        padding: 40px 20px;
        color: rgba(255, 255, 255, 0.7);
    }
    
    .cepage-summary {
        background: rgba(255, 255, 255, 0.95);
        padding: 12px;
        border-radius: 0;
        margin-bottom: 10px;
        border-left: 4px solid var(--primary);
    }
    
    .cepage-summary h3 {
        margin-bottom: 8px;
        color: var(--primary);
        font-size: 16px;
    }
    
    .missing-cepages {
        background: rgba(239, 68, 68, 0.1);
        border-left: 4px solid #ef4444;
        padding: 12px;
        border-radius: 0;
        margin-bottom: 12px;
    }
    
    .missing-cepages h3 {
        color: #ef4444;
        margin-bottom: 8px;
        font-size: 16px;
    }
    
    .missing-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }
    
    .missing-badge {
        background: white;
        padding: 4px 10px;
        border-radius: 0;
        font-size: 12px;
        border: 1px solid #ef4444;
        color: #ef4444;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .missing-badge:hover {
        background: #ef4444;
        color: white;
    }
    
    .history-item {
        background: rgba(255, 255, 255, 0.7);
        padding: 8px;
        margin-bottom: 6px;
        border-radius: 0;
        font-size: 12px;
    }

    /* Nouveaux styles pour page d'accueil */
    .home-stats {
        text-align: center;
        margin: 30px 0 20px;
        padding: 0;
        display: flex;
        align-items: baseline;
        justify-content: center;
        gap: 8px;
    }

    .total-bottles {
        font-family: 'Playfair Display', serif;
        font-size: 48px;
        font-weight: 700;
        color: var(--secondary);
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        line-height: 1;
    }

    .total-label {
        font-size: 16px;
        color: rgba(255, 255, 255, 0.8);
        font-weight: 300;
        letter-spacing: 1px;
    }

    .grape-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 8px;
        margin-top: 30px;
    }

    .grape-summary-card {
        background: linear-gradient(135deg, rgba(30, 58, 95, 0.9) 0%, rgba(15, 39, 68, 0.9) 100%);
        backdrop-filter: blur(10px);
        padding: 12px;
        border-radius: 50%;
        aspect-ratio: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        text-align: center;
        transition: all 0.2s;
        cursor: pointer;
        border: 2px solid transparent;
    }

    .grape-summary-card:hover {
        border-color: var(--secondary);
    }

    .grape-summary-card:active {
        transform: scale(0.95);
    }

    .grape-summary-name {
        font-size: 10px;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 4px;
        line-height: 1.2;
    }

    .grape-summary-count {
        font-family: 'Playfair Display', serif;
        font-size: 24px;
        font-weight: 700;
        color: var(--secondary);
        text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
    }

    .section-divider {
        margin: 30px 0 16px;
        padding-bottom: 8px;
        border-bottom: 2px solid rgba(255, 255, 255, 0.2);
    }

    .section-divider h2 {
        font-family: 'Playfair Display', serif;
        font-size: 20px;
        color: rgba(255, 255, 255, 0.9);
        font-weight: 600;
    }

    .list-menu-item {
        padding: 12px;
        margin-bottom: 4px;
        cursor: pointer;
        border-radius: 0;
        transition: all 0.2s;
        font-size: 14px;
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-dark);
    }

    .list-menu-item:hover {
        background: rgba(30, 58, 95, 0.1);
    }

    .list-menu-item.active {
        background: var(--primary);
        color: white;
        font-weight: 600;
    }

    .list-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        margin-bottom: 6px;
        background: var(--bg-light);
        border-radius: 0;
        border-left: 3px solid var(--primary);
    }

    .list-item-actions {
        display: flex;
        gap: 8px;
    }

    .list-item-actions button {
        padding: 6px 12px;
        font-size: 12px;
        border: none;
        border-radius: 0;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-edit {
        background: var(--primary);
        color: white;
    }

    .btn-delete {
        background: #dc2626;
        color: white;
    }
</style>


</head>
<body>

<div id="scanner">
    <button class="btn-close-scan" onclick="stopScan()">‚úï FERMER</button>
    <div id="scannerVideo"></div>
    <div class="line-guide"></div>
</div>

<div class="header">
    <div class="version">12/01/2026 v3</div>
    <h1>VINO</h1>
    <div class="subtitle">Collectionssss Priv√©e</div>
</div>

<div class="container">
    <div id="page1" class="page">
        <div class="home-stats">
            <span class="total-bottles" id="totalBottles">0</span>
            <span class="total-label">bouteillesssss</span>
        </div>
        
        <div class="scan-hero">
            <div class="scan-buttons">
                <div style="text-align: center;">
                    <button class="btn-scan-large" onclick="quickScan()">üì∑</button>
                    <div class="scan-label">Scanner</div>
                </div>
                <div style="text-align: center;">
                    <button class="btn-scan-large" style="background: var(--secondary);" onclick="showWineModal()">‚å®Ô∏è</button>
                    <div class="scan-label">Ajouter</div>
                </div>
            </div>
        </div>
        <div class="grape-summary-grid" id="grapeSummaryGrid"></div>
    </div> 

    <div id="page2" class="page">
        <div class="filter-bar">
            <label style="font-size: 13px; font-weight: 700; margin-bottom: 8px; display: block; color: var(--primary);">C√âPAGES BLANCS</label>
            <div class="cepage-filter-grid" id="cepageFilterWhite"></div>
            
            <label style="font-size: 13px; font-weight: 700; margin: 16px 0 8px; display: block; color: var(--primary);">C√âPAGES ROUGES</label>
            <div class="cepage-filter-grid" id="cepageFilterRed"></div>
            
            <select id="filterType" onchange="applyFilters()">
                <option value="">Tous les types</option>
                <option value="Rouge">Rouge</option>
                <option value="Blanc">Blanc</option>
                <option value="Ros√©">Ros√©</option>
                <option value="Mousseux">Mousseux</option>
            </select>
            <select id="filterCountry" onchange="applyFilters()">
                <option value="">Tous les pays</option>
            </select>
            <select id="filterRegion" onchange="applyFilters()">
                <option value="">Toutes les r√©gions</option>
            </select>
            <select id="filterAccord" onchange="applyFilters()">
                <option value="">Tous les accords</option>
                <option value="Ap√©ro">Ap√©ro</option>
                <option value="Asiatique">Asiatique</option>
                <option value="Cuisine grecque">Cuisine grecque</option>
                <option value="Cuisine indienne">Cuisine indienne</option>
                <option value="Cuisine italienne (p√¢tes)">Cuisine italienne</option>
                <option value="Dessert">Dessert</option>
                <option value="Fromage">Fromage</option>
                <option value="Friture">Friture</option>
                <option value="Grillades">Grillades</option>
                <option value="Mets portugais">Mets portugais</option>
                <option value="Mets traditionnels">Mets traditionnels</option>
                <option value="Moyen orient">Moyen orient</option>
                <option value="No√´l">No√´l</option>
                <option value="Pizza">Pizza</option>
                <option value="Poisson">Poisson</option>
                <option value="Polyvalent">Polyvalent</option>
                <option value="Poulet">Poulet</option>
                <option value="Saumon">Saumon</option>
                <option value="Saucisses">Saucisses</option>
                <option value="Tomates">Tomates</option>
                <option value="ZZZ - Ne pas racheter">Ne pas racheter</option>
            </select>
            <input type="text" id="searchWine" placeholder="Rechercher par nom..." onkeyup="applyFilters()">
        </div>
        <div id="wineList"></div>
    </div>

    <div id="page3" class="page">
        <div class="filter-bar">
            <select id="viewZone" onchange="showLocations()">
                <option value="1">Cellier</option>
                <option value="2">Casiers</option>
                <option value="3">R√©serve</option>
            </select>
        </div>
        <div id="locationView"></div>
    </div>

    <div id="page4" class="page">
        <div class="filter-bar">
            <select id="cepageZone" onchange="showCepagesByCellier()">
                <option value="0">Tous</option>
                <option value="1">Cellier</option>
                <option value="2">Casiers</option>
                <option value="3">R√©serve</option>
            </select>
        </div>
        <div id="cepageView"></div>
    </div>

    <div id="page5" class="page">
        <div id="shoppingList"></div>
    </div>

    <div id="page6" class="page">
        <div class="filter-bar">
            <button class="btn-secondary" onclick="showWineModal()">‚ûï Ajouter un vin</button>
            <button class="btn-secondary" onclick="showManageLists()">üìù G√©rer les listes</button>
            <button class="btn-secondary" onclick="exportToExcel()">üìä Exporter Excel</button>
            <button class="btn-secondary" onclick="document.getElementById('importFile').click()">üì§ Importer</button>
        </div>
    </div>
</div> <div class="nav">
    <div class="nav-item" onclick="showPage(1)">
        <div style="font-size: 24px;">üç∑</div>
        <div class="nav-label">Accueil</div>
    </div>
    <div class="nav-item" onclick="showPage(2)">
        <div style="font-size: 24px;">üîç</div>
        <div class="nav-label">Recherche</div>
    </div>
    <div class="nav-item" onclick="showPage(3)">
        <div style="font-size: 24px;">üçæ</div>
        <div class="nav-label">Celliers</div>
    </div>
    <div class="nav-item" onclick="showPage(4)">
        <div style="font-size: 24px;">üçá</div>
        <div class="nav-label">C√©pages</div>
    </div>
    <div class="nav-item" onclick="showPage(5)">
        <div style="font-size: 24px;">üõí</div>
        <div class="nav-label">Achats</div>
    </div>
    <div class="nav-item" onclick="showPage(6)">
        <div style="font-size: 24px;">‚öôÔ∏è</div>
        <div class="nav-label">Gestion</div>
    </div>
</div>

<div id="wineModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle">Ajouter un vin</div>
            <button class="close-btn" onclick="closeWineModal()">√ó</button>
        </div>
        <div class="form-group">
            <label>Code-barres</label>
            <input type="text" id="barcode" placeholder="Scanner ou saisir">
        </div>
        <div class="form-group">
            <label>Nom du vin *</label>
            <input type="text" id="wineName" required>
        </div>
        <div class="form-group">
            <label>URL SAQ</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="saqUrl" placeholder="https://..." style="flex: 1;">
                <button type="button" class="btn-secondary" onclick="window.open('https://www.saq.com/fr/', '_blank')" style="width: auto; padding: 12px 20px; margin: 0;">üîó SAQ</button>
            </div>
        </div>
        <div class="form-group">
            <label>Type de vin *</label>
            <select id="wineType" onchange="updateCepageList(this.value)" required>
                <option value="">S√©lectionner</option>
                <option value="Rouge">Rouge</option>
                <option value="Blanc">Blanc</option>
                <option value="Ros√©">Ros√©</option>
                <option value="Mousseux">Mousseux</option>
            </select>
        </div>
        <div class="form-group">
            <label>Pays</label>
            <select id="country" onchange="updateRegions()">
                <option value="">S√©lectionner</option>
            </select>
        </div>
        <div class="form-group">
            <label>C√©pages</label>
            <div class="checkbox-grid" id="cepageList"></div>
        </div>
        <div class="form-group">
            <label>Emplacements</label>
            <div id="locationEntries"></div>
            <button type="button" class="btn-secondary" onclick="addLocationEntry()">+ Ajouter un emplacement</button>
        </div>
        <button type="button" class="btn-primary" onclick="saveWine()" id="saveBtn">Ajouter au Cellier</button>
    </div>
</div>

<div id="wineModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeWineModal()">√ó</button>
        <h2 id="modalTitle" style="margin-bottom:15px;">Ajouter un vin</h2>
        
        <input type="text" id="wineName" placeholder="Nom du vin (ex: Apothic Red)" style="width:100%; padding:12px; margin-bottom:10px; border:1px solid #ccc; border-radius:8px;">
        
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <select id="wineType" onchange="updateCepageList(this.value)" style="flex:1; padding:10px; border-radius:8px;">
                <option value="">Type...</option>
                <option value="Rouge">Rouge</option>
                <option value="Blanc">Blanc</option>
                <option value="Ros√©">Ros√©</option>
            </select>
            <select id="country" style="flex:1; padding:10px; border-radius:8px;">
                <option value="">Pays...</option>
            </select>
        </div>

        <div style="font-size:12px; margin-bottom:5px; font-weight:bold;">C√©pages :</div>
        <div id="cepageList" style="display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-bottom:15px; max-height:120px; overflow-y:auto; border:1px solid #eee; padding:8px; border-radius:8px;">
            </div>

        <div style="font-size:12px; margin-bottom:5px; font-weight:bold;">Emplacements :</div>
        <div id="locationEntries"></div>
        <button onclick="addLocationEntry()" style="width:100%; background:#f0f0f0; border:1px dashed #ccc; padding:8px; margin-top:5px; border-radius:8px; cursor:pointer;">+ Ajouter une bouteille</button>
        
        <button class="btn-primary" onclick="saveWine()" style="width:100%; margin-top:20px; padding:15px; font-size:16px;">ENREGISTRER</button>
    </div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeDetailModal()">√ó</button>
        <div id="wineDetail"></div>
    </div>
</div>

<div id="removeModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeRemoveModal()">√ó</button>
        <h3 id="removeWineName" style="color:var(--primary);"></h3>
        <p style="font-size:14px; margin-bottom:15px;">S√©lectionnez la bouteille √† retirer :</p>
        <div id="removeLocationsList"></div>
    </div>
</div>

<input type="file" id="importFile" accept=".json,.xlsx" style="display: none;" onchange="handleImport(event)">

<script>
    // --- 1. VOS DONN√âES ET √âTAT ---
    let wines = JSON.parse(localStorage.getItem('wines')) || [];
    let editingId = null;
    let currentWineId = null;

    // Vos listes de pays et r√©gions
    const countries = ['France', 'Italie', 'Espagne', 'Portugal', 'Canada', '√âtats-Unis', 'Argentine', 'Chili', 'Australie', 'Nouvelle-Z√©lande', 'Afrique du Sud', 'Allemagne'].sort();
    const regionsByCountry = {
        'France': ['Alsace', 'Beaujolais', 'Bordeaux', 'Bourgogne', 'Champagne', 'Jura', 'Languedoc', 'Loire', 'Provence', 'Rh√¥ne', 'Roussillon', 'Savoie', 'Sud-Ouest'],
        'Italie': ['Pi√©mont', 'Toscane', 'V√©n√©tie', 'Sicile', 'Pouilles', 'Lombardie', 'Trentin'],
        'Espagne': ['Rioja', 'Ribera del Duero', 'Priorat', 'Navarre', 'Catalogne', 'R√≠as Baixas'],
        'Portugal': ['Douro', 'Alentejo', 'D√£o', 'Vinho Verde'],
        'Canada': ['Colombie-Britannique', 'Ontario', 'Qu√©bec'],
        '√âtats-Unis': ['Californie', 'Oregon', 'Washington', 'New York']
    };

    // Vos listes de c√©pages et accords
    const cepagesBlancs = ['Chardonnay', 'Sauvignon Blanc', 'S√©millon', 'Chenin Blanc', 'Riesling', 'Gew√ºrztraminer', 'Pinot Blanc', 'Pinot Gris/Grigio', 'Viognier', 'Muscat Blanc', 'Sylvaner', 'Malvasia', 'Trebbiano', 'Albari√±o', 'Verdejo', 'Vermentino', 'Marsanne', 'Roussanne', 'Gr√ºner Veltliner'].sort();
    const cepagesRouges = ['Cabernet Sauvignon', 'Pinot Noir', 'Merlot', 'Syrah/Shiraz', 'Cabernet Franc', 'Gamay', 'Grenache', 'Cinsault', 'Carignan', 'Barbera', 'Sangiovese', 'Zinfandel', 'Tempranillo', 'Nebbiolo', 'Mourv√®dre', 'Malbec', 'Moscato'].sort();
    const accords = ['Ap√©ro', 'Asiatique', 'Cuisine grecque', 'Cuisine indienne', 'Cuisine italienne (p√¢tes)', 'Dessert', 'Fromage', 'Friture', 'Grillades', 'Mets portugais', 'Mets traditionnels', 'Moyen orient', 'No√´l', 'Pizza', 'Poisson', 'Polyvalent', 'Poulet', 'Saumon', 'Saucisses', 'Tomates', 'ZZZ - Ne pas racheter'].sort();

    // --- 2. NAVIGATION ---
    function showPage(n) {
        document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
        const target = document.getElementById('page' + n);
        if (target) target.style.display = 'block';
        
        document.querySelectorAll('.nav-item').forEach((item, index) => {
            if (index + 1 === n) item.classList.add('active');
            else item.classList.remove('active');
        });

        if (n === 1) updateHomePage();
        if (n === 2) render();
        if (n === 5) updateShoppingList();
        window.scrollTo(0, 0);
    }

    // --- 3. INITIALISATION ---
    window.onload = function() {
        initFormElements();
        updateHomePage();
        showPage(1);
    };

    function initFormElements() {
        const countrySelect = document.getElementById('country');
        const filterCountry = document.getElementById('filterCountry');
        countries.forEach(c => {
            countrySelect.add(new Option(c, c));
            filterCountry.add(new Option(c, c));
        });

        // Init filtres c√©pages recherche (Page 2)
        const whiteFilter = document.getElementById('cepageFilterWhite');
        cepagesBlancs.forEach(c => {
            const div = document.createElement('div');
            div.className = 'cepage-filter-item';
            div.innerHTML = `<input type="checkbox" id="filter_${c}" value="${c}" onchange="applyFilters()"><label for="filter_${c}">${c}</label>`;
            whiteFilter.appendChild(div);
        });

        const redFilter = document.getElementById('cepageFilterRed');
        cepagesRouges.forEach(c => {
            const div = document.createElement('div');
            div.className = 'cepage-filter-item';
            div.innerHTML = `<input type="checkbox" id="filter_${c}" value="${c}" onchange="applyFilters()"><label for="filter_${c}">${c}</label>`;
            redFilter.appendChild(div);
        });
    }

    // --- 4. GESTION DU VIN (MODALE) ---
    function showWineModal(id = null) {
        editingId = id;
        const entries = document.getElementById('locationEntries');
        entries.innerHTML = '';

        if (id) {
            const wine = wines.find(w => w.id === id);
            document.getElementById('modalTitle').textContent = "Modifier le vin";
            document.getElementById('wineName').value = wine.name;
            document.getElementById('wineType').value = wine.type;
            document.getElementById('country').value = wine.country || '';
            updateCepageList(wine.type);
            // Cocher c√©pages existants
            wine.cepages.forEach(c => { const cb = document.getElementById('cep_'+c); if(cb) cb.checked = true; });
            wine.locations.forEach(loc => addLocationEntry(loc));
        } else {
            document.getElementById('modalTitle').textContent = "Ajouter un vin";
            document.getElementById('wineName').value = '';
            document.getElementById('wineType').value = '';
            updateCepageList('');
            addLocationEntry(); // Un par d√©faut
        }
        document.getElementById('wineModal').style.display = 'flex';
    }

    function saveWine() {
        const name = document.getElementById('wineName').value.trim();
        const type = document.getElementById('wineType').value;
        if (!name || !type) return alert("Nom et Type requis");

        const locs = [];
        document.querySelectorAll('.location-entry').forEach(entry => {
            const z = entry.querySelector('.location-zone').value;
            const r = entry.querySelector('.location-rangee').value;
            const e = entry.querySelector('.location-espace').value;
            if (z && r && e) locs.push({ zone: z, rangee: r, espace: e });
        });

        const wineData = {
            id: editingId || Date.now(),
            name,
            type,
            country: document.getElementById('country').value,
            cepages: Array.from(document.querySelectorAll('#cepageList input:checked')).map(cb => cb.value),
            locations: locs
        };

        if (editingId) {
            const idx = wines.findIndex(w => w.id === editingId);
            wines[idx] = wineData;
        } else {
            wines.push(wineData);
        }

        localStorage.setItem('wines', JSON.stringify(wines));
        closeWineModal();
        updateHomePage();
        render();
    }

    // --- 5. BOIRE / RETRAIT ---
    function showRemoveModal(id) {
        currentWineId = id;
        const wine = wines.find(w => w.id === id);
        const container = document.getElementById('removeLocationsList');
        document.getElementById('removeWineName').textContent = wine.name;
        
        container.innerHTML = wine.locations.map((loc, index) => `
            <div style="background:#f1f1f1; padding:12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; border-radius:8px;">
                <span>Cellier ${loc.zone} ‚Ä¢ R${loc.rangee} ‚Ä¢ ${loc.espace}</span>
                <button onclick="confirmRemoval(${index})" style="background:#8B0000; color:white; border:none; padding:8px 15px; border-radius:5px;">BOIRE</button>
            </div>
        `).join('');
        document.getElementById('removeModal').style.display = 'flex';
    }

    function confirmRemoval(index) {
        const wineIdx = wines.findIndex(w => w.id === currentWineId);
        wines[wineIdx].locations.splice(index, 1);
        localStorage.setItem('wines', JSON.stringify(wines));
        closeRemoveModal();
        closeDetailModal();
        render();
        updateHomePage();
    }

    // --- 6. AFFICHAGE ET LISTE DE COURSES ---
    function updateHomePage() {
        let total = 0;
        const grapeCounts = {};
        wines.forEach(w => {
            const q = w.locations.length;
            total += q;
            if(q > 0) w.cepages.forEach(c => grapeCounts[c] = (grapeCounts[c] || 0) + q);
        });
        document.getElementById('totalBottles').textContent = total;
        
        const grid = document.getElementById('grapeSummaryGrid');
        grid.innerHTML = Object.entries(grapeCounts).sort((a,b)=>b[1]-a[1]).map(([name, count]) => `
            <div class="grape-summary-card" onclick="filterByGrape('${name}')">
                <div class="grape-summary-name">${name}</div>
                <div class="grape-summary-count">${count}</div>
            </div>
        `).join('');
    }

    function updateShoppingList() {
        const container = document.getElementById('shoppingList');
        const toBuy = wines.filter(w => w.locations.length === 0);
        
        if (toBuy.length === 0) {
            container.innerHTML = '<div class="empty">Aucun vin √† racheter üéâ</div>';
            return;
        }

        container.innerHTML = '<h3 style="padding:15px;">√Ä Racheter</h3>' + toBuy.map(w => `
            <div class="wine-card" onclick="showDetail(${w.id})">
                <div class="wine-name">${getWineTypeIcon(w.type)} ${w.name}</div>
                <div style="color:red; font-size:12px;">STOCK √âPUIS√â</div>
            </div>
        `).join('');
    }

    function render() {
        const search = document.getElementById('searchWine').value.toLowerCase();
        const list = document.getElementById('wineList');
        const filtered = wines.filter(w => w.name.toLowerCase().includes(search) && w.locations.length > 0);
        
        list.innerHTML = filtered.map(w => `
            <div class="wine-card" onclick="showDetail(${w.id})">
                <div class="wine-name">${getWineTypeIcon(w.type)} ${w.name}</div>
                <div class="badge">${w.locations.length} bouteille(s)</div>
            </div>
        `).join('');
    }

    function showDetail(id) {
        const wine = wines.find(w => w.id === id);
        document.getElementById('wineDetail').innerHTML = `
            <h2>${wine.name}</h2>
            <p>${getWineTypeIcon(wine.type)} ${wine.type} - ${wine.country || ''}</p>
            <div style="margin:15px 0;">${wine.locations.map(l => `<span class="badge">C${l.zone}-R${l.rangee}-${l.espace}</span>`).join(' ')}</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn-primary" onclick="showRemoveModal(${wine.id})">BOIRE</button>
                <button class="btn-secondary" onclick="closeDetailModal(); showWineModal(${wine.id})">MODIFIER</button>
            </div>
        `;
        document.getElementById('detailModal').style.display = 'flex';
    }

    // --- 7. UTILITAIRES ---
    function addLocationEntry(data = {zone:'1', rangee:'1', espace:'A'}) {
        const div = document.createElement('div');
        div.className = 'location-entry';
        div.innerHTML = `
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <select class="location-zone"><option value="1" ${data.zone==='1'?'selected':''}>Cellier</option><option value="2" ${data.zone==='2'?'selected':''}>Casiers</option><option value="3" ${data.zone==='3'?'selected':''}>R√©serve</option></select>
                <select class="location-rangee">${Array.from({length:10},(_,i)=>`<option value="${i+1}" ${data.rangee==i+1?'selected':''}>R${i+1}</option>`).join('')}</select>
                <select class="location-espace"><option value="A" ${data.espace==='A'?'selected':''}>A</option><option value="B" ${data.espace==='B'?'selected':''}>B</option><option value="C" ${data.espace==='C'?'selected':''}>C</option></select>
                <button onclick="this.parentElement.remove()" style="background:red; color:white; border:none; padding:5px 10px; border-radius:4px;">‚úï</button>
            </div>`;
        document.getElementById('locationEntries').appendChild(div);
    }

    function updateCepageList(type) {
        const grid = document.getElementById('cepageList');
        grid.innerHTML = '';
        const list = (type === 'Blanc') ? cepagesBlancs : (type === 'Rouge' ? cepagesRouges : [...cepagesBlancs, ...cepagesRouges]);
        list.forEach(c => {
            const div = document.createElement('div');
            div.className = 'checkbox-item';
            div.innerHTML = `<input type="checkbox" id="cep_${c}" value="${c}"><label for="cep_${c}">${c}</label>`;
            grid.appendChild(div);
        });
    }

    function getWineTypeIcon(t) {
        const c = { 'Rouge': '#8B0000', 'Blanc': '#F5DEB3', 'Ros√©': '#FFB6C1' };
        return `<span style="display:inline-block;width:12px;height:12px;background:${c[t]||'#888'};border-radius:50%;border:1px solid #ccc"></span>`;
    }

    function filterByGrape(g) { showPage(2); document.getElementById('filter_'+g).checked = true; applyFilters(); }
    function closeWineModal() { document.getElementById('wineModal').style.display = 'none'; }
    function closeDetailModal() { document.getElementById('detailModal').style.display = 'none'; }
    function closeRemoveModal() { document.getElementById('removeModal').style.display = 'none'; }
    function applyFilters() { render(); }
    function quickScan() { alert("Scanner en attente de config."); }
</script>

</body>
</html>

