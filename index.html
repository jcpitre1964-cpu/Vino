<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>VINO v2.4 - Version Int√©grale</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Lato:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* --- STYLES ORIGINAUX COMPLETS --- */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root {
            --primary: #1E3A5F; --primary-dark: #0F2744; --secondary: #D4AF37;
            --bg-light: #F8F6F3; --text-dark: #2C2C2C; --text-light: #6B6B6B;
            --border: #E8E3DC; --cellier1: #8B4513; --cellier2: #2F4F4F; --cellier3: #8B0000;
        }
        body { font-family: 'Lato', sans-serif; background: #000; color: var(--text-dark); padding-bottom: 80px; min-height: 100vh; position: relative; overflow-x: hidden; }
        
        /* Background original */
        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(30, 58, 95, 0.8), rgba(15, 39, 68, 0.9)), 
                        url('https://images.unsplash.com/photo-1506377247377-2a5b3b0ca7df?auto=format&fit=crop&q=80&w=2000');
            background-size: cover; background-position: center; z-index: -1;
        }

        .header { background: rgba(30, 58, 95, 0.95); padding: 20px; text-align: center; border-bottom: 2px solid var(--secondary); box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .header h1 { font-family: 'Playfair Display', serif; font-size: 38px; color: var(--secondary); letter-spacing: 6px; text-transform: uppercase; }

        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        .page { display: none; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Navigation Originale (6 √©l√©ments) */
        .nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(30, 58, 95, 0.98); display: flex; padding: 10px 0; border-top: 1px solid var(--secondary); z-index: 1000; }
        .nav-item { flex: 1; text-align: center; color: white; opacity: 0.5; font-size: 9px; cursor: pointer; transition: 0.3s; text-transform: uppercase; }
        .nav-item.active { opacity: 1; color: var(--secondary); }
        .nav-item span { display: block; font-size: 22px; margin-bottom: 3px; }

        /* Cards Design */
        .wine-card { background: white; margin-bottom: 12px; padding: 15px; border-radius: 12px; border-left: 6px solid var(--primary); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        .stat-bubble { background: rgba(255,255,255,0.1); border: 1px solid var(--secondary); padding: 15px; border-radius: 15px; text-align: center; color: white; margin-bottom: 15px; }

        /* Formulaire & Modales */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; overflow-y: auto; padding: 15px; }
        .modal.active { display: block; }
        .modal-content { background: var(--bg-light); border-radius: 15px; padding: 25px; max-width: 500px; margin: 20px auto; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; background: white; }
        
        .checkbox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; background: white; padding: 12px; border-radius: 8px; border: 1px solid var(--border); max-height: 150px; overflow-y: auto; margin-bottom: 15px; }
        .checkbox-item { font-size: 13px; display: flex; align-items: center; gap: 8px; }

        .btn-main { background: var(--secondary); color: var(--primary-dark); border: none; padding: 15px; border-radius: 8px; font-weight: 700; width: 100%; cursor: pointer; letter-spacing: 1px; }
        
        /* Scanner */
        #scannerLayer { display: none; position: fixed; inset: 0; background: #000; z-index: 9999; }
        #scannerLayer.active { display: block; }
        #videoStream { width: 100%; height: 80vh; object-fit: cover; }
    </style>
</head>
<body>

    <div class="header"><h1>VINO</h1></div>

    <div class="container">
        <div id="page1" class="page active">
            <div style="text-align: center; margin: 40px 0;">
                <div style="font-size: 65px; color: var(--secondary); font-family: 'Playfair Display';" id="totalBottles">0</div>
                <p style="color: white; letter-spacing: 3px; font-weight: 300;">BOUTEILLES EN CAVE</p>
                <button onclick="app.startScanner()" class="btn-main" style="width: auto; padding: 15px 40px; border-radius: 50px; margin-top: 30px;">üì∑ SCANNER UN CODE</button>
            </div>
            <div id="topCepages" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;"></div>
        </div>

        <div id="page2" class="page">
            <input type="text" id="mainSearch" placeholder="Rechercher nom, pays, c√©page..." onkeyup="app.renderList()">
            <div id="listContainer"></div>
        </div>

        <div id="page3" class="page">
            <h2 style="color: white; margin-bottom: 20px; font-family: 'Playfair Display';">Mes Celliers</h2>
            <div id="celliersList"></div>
        </div>

        <div id="page4" class="page">
            <h2 style="color: white; margin-bottom: 20px; font-family: 'Playfair Display';">Statistiques</h2>
            <div id="statsFull" class="stat-bubble">Chargement...</div>
        </div>

        <div id="page5" class="page">
            <h2 style="color: white; margin-bottom: 20px; font-family: 'Playfair Display';">Accords Mets & Vins</h2>
            <div id="accordsContainer"></div>
        </div>

        <div id="page6" class="page">
            <button class="btn-main" onclick="app.openModal()">‚ûï AJOUTER MANUELLEMENT</button>
            <div style="margin-top: 25px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 25px;">
                <button class="btn-main" style="background: #444; color: white; margin-bottom: 15px;" onclick="app.exportExcel()">üì§ EXPORTER EXCEL</button>
                <label style="color: white; font-size: 12px; display: block; margin-bottom: 5px;">Importer fichier JSON :</label>
                <input type="file" id="importJson" onchange="app.importData(event)" style="background: white;">
                <button class="btn-main" style="background: #8b0000; color: white; margin-top: 40px;" onclick="app.clearAll()">‚ö†Ô∏è R√âINITIALISER LA CAVE</button>
            </div>
        </div>
    </div>

    <div class="nav">
        <div class="nav-item active" onclick="app.nav(1, this)"><span>üè†</span>Accueil</div>
        <div class="nav-item" onclick="app.nav(2, this)"><span>üîç</span>Liste</div>
        <div class="nav-item" onclick="app.nav(3, this)"><span>üì¶</span>Celliers</div>
        <div class="nav-item" onclick="app.nav(4, this)"><span>üìä</span>Stats</div>
        <div class="nav-item" onclick="app.nav(5, this)"><span>üç¥</span>Accords</div>
        <div class="nav-item" onclick="app.nav(6, this)"><span>‚öôÔ∏è</span>Gestion</div>
    </div>

    <div id="wineModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle" style="margin-bottom: 15px;">D√©tails du Vin</h2>
            <input type="hidden" id="f-id">
            
            <label>Code-barres</label>
            <input type="text" id="f-barcode">
            
            <label>Nom du vin *</label>
            <input type="text" id="f-name">
            
            <label>Type de vin</label>
            <select id="f-type" onchange="app.syncCepages()">
                <option value="Rouge">Rouge</option>
                <option value="Blanc">Blanc</option>
                <option value="Ros√©">Ros√©</option>
                <option value="Mousseux">Mousseux</option>
                <option value="Dessert">Dessert</option>
            </select>

            <label>Pays</label>
            <select id="f-country" onchange="app.syncRegions()"></select>
            
            <label>R√©gion</label>
            <select id="f-region"></select>

            <label>C√©pages (plusieurs possibles)</label>
            <div id="f-cepages" class="checkbox-grid"></div>

            <label>Accords Mets</label>
            <div id="f-accords" class="checkbox-grid"></div>

            <div style="background: #e9ecef; padding: 15px; border-radius: 10px; margin: 15px 0;">
                <strong style="display: block; margin-bottom: 10px;">Gestion des Stocks :</strong>
                <div id="f-stockRows"></div>
                <button type="button" onclick="app.addStockRow()" style="background: #1E3A5F; color: white; border: none; padding: 8px; border-radius: 5px; font-size: 12px;">+ Ajouter Cellier</button>
            </div>

            <button class="btn-main" onclick="app.save()">ENREGISTRER</button>
            <button onclick="app.closeModal()" style="width: 100%; border: none; background: none; margin-top: 15px; color: #666;">Annuler</button>
        </div>
    </div>

    <div id="scannerLayer">
        <div id="videoStream"></div>
        <button onclick="app.stopScanner()" style="width: 100%; height: 20vh; background: red; color: white; border: none; font-size: 20px; font-weight: bold;">ANNULER LE SCAN</button>
    </div>

    <script>
    const app = {
        wines: JSON.parse(localStorage.getItem('vino_db_v24')) || [],
        
        // --- TOUTES LES DONN√âES ORIGINALES ---
        config: {
            countries: ['France','Italie','Espagne','Portugal','Canada','√âtats-Unis','Australie','Nouvelle-Z√©lande','Argentine','Chili','Afrique du Sud','Allemagne','Autriche','Gr√®ce','Liban'].sort(),
            regions: {
                'France': ['Alsace','Beaujolais','Bordeaux','Bourgogne','Champagne','Jura','Languedoc','Loire','Provence','Rh√¥ne','Roussillon','Savoie','Sud-Ouest'],
                'Italie': ['Pi√©mont','Toscane','V√©n√©tie','Sicile','Pouilles','Abruzzes','Lombardie','Ombrie'],
                'Espagne': ['Rioja','Ribera del Duero','Priorat','Catalogne','Galice','Andalousie'],
                'Canada': ['Qu√©bec','Ontario','Colombie-Britannique','Nouvelle-√âcosse'],
                '√âtats-Unis': ['Californie','Oregon','Washington','New York']
            },
            cepages: {
                'Rouge': ['Cabernet Sauvignon','Merlot','Pinot Noir','Syrah','Grenache','Malbec','Sangiovese','Nebbiolo','Tempranillo','Gamay','Cabernet Franc','Zinfandel','Mourv√®dre'],
                'Blanc': ['Chardonnay','Sauvignon Blanc','Riesling','Pinot Gris','Chenin Blanc','Viognier','Gewurztraminer','Muscadet','Aligot√©','Gr√ºner Veltliner'],
                'Ros√©': ['Grenache','Cinsault','Syrah','Mourv√®dre','Pinot Noir','Gamay']
            },
            accords: ['Ap√©ro','Poisson','Fruits de Mer','Viande Rouge','Viande Blanche','Grillades','P√¢tes Sauce Rouge','P√¢tes Sauce Blanche','Fromages Forte','Fromages Doux','Desserts Chocolat','Desserts Fruits','Plats √âpic√©s']
        },

        init() {
            this.populateSelect('f-country', this.config.countries);
            this.populateCheckboxes('f-accords', this.config.accords);
            this.syncCepages();
            this.syncRegions();
            this.refreshUI();
        },

        // --- NAVIGATION ---
        nav(num, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('page' + num).classList.add('active');
            el.classList.add('active');
            this.refreshUI();
        },

        refreshUI() {
            this.updateDashboard();
            this.renderList();
            this.renderCelliers();
            this.renderStats();
            this.renderAccords();
        },

        // --- FORMULAIRE LOGIQUE ---
        populateSelect(id, list) {
            const el = document.getElementById(id);
            el.innerHTML = list.map(i => `<option value="${i}">${i}</option>`).join('');
        },

        populateCheckboxes(containerId, list) {
            const cont = document.getElementById(containerId);
            cont.innerHTML = list.map(i => `
                <label class="checkbox-item"><input type="checkbox" value="${i}"> ${i}</label>
            `).join('');
        },

        syncRegions() {
            const country = document.getElementById('f-country').value;
            const regs = this.config.regions[country] || ['Autre / Inconnu'];
            this.populateSelect('f-region', regs);
        },

        syncCepages() {
            const type = document.getElementById('f-type').value;
            const list = this.config.cepages[type] || this.config.cepages['Rouge'];
            this.populateCheckboxes('f-cepages', list);
        },

        addStockRow(data = {cellier: '1', qte: 1}) {
            const div = document.createElement('div');
            div.className = "stock-row";
            div.style = "display: flex; gap: 8px; margin-bottom: 8px;";
            div.innerHTML = `
                <select class="s-cell" style="flex:2; margin:0;"><option value="1" ${data.cellier=='1'?'selected':''}>Cellier 1</option><option value="2" ${data.cellier=='2'?'selected':''}>Cellier 2</option><option value="3" ${data.cellier=='3'?'selected':''}>Cellier 3</option></select>
                <input type="number" class="s-qte" value="${data.qte}" style="flex:1; margin:0;" min="0">
                <button onclick="this.parentElement.remove()" style="background:none; border:none; color:red; font-size:18px;">‚úï</button>
            `;
            document.getElementById('f-stockRows').appendChild(div);
        },

        // --- ACTIONS DONN√âES ---
        save() {
            const id = document.getElementById('f-id').value;
            const name = document.getElementById('f-name').value;
            if(!name) return alert("Le nom est obligatoire");

            const stocks = Array.from(document.querySelectorAll('.stock-row')).map(row => ({
                cellier: row.querySelector('.s-cell').value,
                qte: parseInt(row.querySelector('.s-qte').value) || 0
            })).filter(s => s.qte > 0);

            const wine = {
                id: id || (Date.now() + Math.random().toString(36).substr(2, 5)),
                name,
                barcode: document.getElementById('f-barcode').value,
                type: document.getElementById('f-type').value,
                country: document.getElementById('f-country').value,
                region: document.getElementById('f-region').value,
                cepages: Array.from(document.querySelectorAll('#f-cepages input:checked')).map(i => i.value),
                accords: Array.from(document.querySelectorAll('#f-accords input:checked')).map(i => i.value),
                stocks,
                total: stocks.reduce((a, b) => a + b.qte, 0)
            };

            if(id) {
                const idx = this.wines.findIndex(w => w.id === id);
                this.wines[idx] = wine;
            } else {
                this.wines.push(wine);
            }

            localStorage.setItem('vino_db_v24', JSON.stringify(this.wines));
            this.closeModal();
            this.refreshUI();
        },

        // --- AFFICHAGES ---
        updateDashboard() {
            const total = this.wines.reduce((a, b) => a + b.total, 0);
            document.getElementById('totalBottles').innerText = total;

            const counts = {};
            this.wines.forEach(w => w.cepages.forEach(c => counts[c] = (counts[c] || 0) + w.total));
            const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 4);
            
            document.getElementById('topCepages').innerHTML = sorted.map(([name, count]) => `
                <div class="stat-bubble">
                    <div style="font-size:24px; font-weight:bold;">${count}</div>
                    <div style="font-size:11px; text-transform:uppercase; opacity:0.8;">${name}</div>
                </div>
            `).join('');
        },

        renderList() {
            const query = document.getElementById('mainSearch').value.toLowerCase();
            const filtered = this.wines.filter(w => w.name.toLowerCase().includes(query) || w.country.toLowerCase().includes(query));
            
            document.getElementById('listContainer').innerHTML = filtered.map(w => `
                <div class="wine-card" onclick="app.openModal('${w.id}')">
                    <div style="font-size:10px; font-weight:bold; color:var(--secondary); text-transform:uppercase; margin-bottom:5px;">${w.type} ‚Ä¢ ${w.country}</div>
                    <div style="font-size:18px; font-weight:700;">${w.name}</div>
                    <div style="font-size:13px; color:var(--text-light); margin-top:5px;">${w.total} bouteille(s)</div>
                </div>
            `).join('');
        },

        renderCelliers() {
            let html = "";
            ['1','2','3'].forEach(num => {
                const total = this.wines.reduce((sum, w) => {
                    const s = w.stocks.find(l => l.cellier === num);
                    return sum + (s ? s.qte : 0);
                }, 0);
                html += `<div class="wine-card" style="border-left-color: var(--cellier${num})">
                    <strong>Cellier ${num}</strong>
                    <div style="font-size:24px; color:var(--primary); font-weight:bold;">${total} <small>btl(s)</small></div>
                </div>`;
            });
            document.getElementById('celliersList').innerHTML = html;
        },

        renderStats() {
            const total = this.wines.reduce((a, b) => a + b.total, 0);
            const types = {};
            this.wines.forEach(w => types[w.type] = (types[w.type] || 0) + w.total);
            
            let html = `<strong>Total : ${total} bouteilles</strong><hr style="margin:10px 0; opacity:0.2;">`;
            Object.entries(types).forEach(([t, q]) => {
                html += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span>${t}</span><span>${q}</span>
                </div>`;
            });
            document.getElementById('statsFull').innerHTML = html;
        },

        renderAccords() {
            const accordsMap = {};
            this.wines.forEach(w => w.accords.forEach(a => {
                if(!accordsMap[a]) accordsMap[a] = [];
                accordsMap[a].push(w.name);
            }));
            
            document.getElementById('accordsContainer').innerHTML = Object.entries(accordsMap).map(([acc, vins]) => `
                <div class="wine-card">
                    <strong style="color:var(--secondary)">üç¥ ${acc}</strong>
                    <div style="font-size:12px; margin-top:5px;">${vins.join(', ')}</div>
                </div>
            `).join('');
        },

        // --- SCANNER ---
        startScanner() {
            document.getElementById('scannerLayer').classList.add('active');
            Quagga.init({
                inputStream: { name: "Live", type: "LiveStream", target: document.querySelector("#videoStream") },
                decoder: { readers: ["ean_reader", "upc_reader", "code_128_reader"] }
            }, (err) => {
                if (err) return alert("Cam√©ra indisponible");
                Quagga.start();
            });

            Quagga.onDetected((res) => {
                this.stopScanner();
                const code = res.codeResult.code;
                const exist = this.wines.find(w => w.barcode === code);
                if(exist) this.openModal(exist.id);
                else { this.openModal(); document.getElementById('f-barcode').value = code; }
            });
        },

        stopScanner() {
            Quagga.stop();
            document.getElementById('scannerLayer').classList.remove('active');
        },

        // --- UTILS ---
        openModal(id = null) {
            document.getElementById('wineModal').classList.add('active');
            document.getElementById('f-id').value = "";
            document.getElementById('f-stockRows').innerHTML = "";
            if(id) {
                const w = this.wines.find(v => v.id === id);
                document.getElementById('f-id').value = w.id;
                document.getElementById('f-name').value = w.name;
                document.getElementById('f-barcode').value = w.barcode || "";
                document.getElementById('f-type').value = w.type;
                this.syncCepages();
                document.getElementById('f-country').value = w.country;
                this.syncRegions();
                document.getElementById('f-region').value = w.region;
                w.stocks.forEach(s => this.addStockRow(s));
                w.cepages.forEach(c => { const cb = document.querySelector(`#f-cepages input[value="${c}"]`); if(cb) cb.checked = true; });
                w.accords.forEach(a => { const cb = document.querySelector(`#f-accords input[value="${a}"]`); if(cb) cb.checked = true; });
            } else {
                this.addStockRow();
            }
        },

        closeModal() { document.getElementById('wineModal').classList.remove('active'); },

        exportExcel() {
            const data = this.wines.map(w => ({
                Nom: w.name, Type: w.type, Pays: w.country, R√©gion: w.region, Quantit√©: w.total, CodeBarres: w.barcode
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Ma Cave");
            XLSX.writeFile(wb, "Vino_Cave_Export.xlsx");
        },

        importData(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    this.wines = JSON.parse(event.target.result);
                    localStorage.setItem('vino_db_v24', JSON.stringify(this.wines));
                    this.refreshUI();
                    alert("Importation r√©ussie !");
                } catch(e) { alert("Fichier invalide"); }
            };
            reader.readAsText(file);
        },

        clearAll() {
            if(confirm("Supprimer TOUT d√©finitivement ?")) {
                localStorage.removeItem('vino_db_v24');
                location.reload();
            }
        }
    };

    window.onload = () => app.init();
    </script>
</body>
</html>
